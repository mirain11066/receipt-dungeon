<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ | å®¶è¨ˆç°¿RPG</title>
    <meta name="description" content="ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ãƒãƒ›ã§æ’®ã‚‹ã ã‘ï¼AIãŒè²·ã„ç‰©ã‚’ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«å¤‰æ›ã—ã¦æˆ¦ã†ã€å®Œå…¨ç„¡æ–™ã®å®¶è¨ˆç°¿RPGã‚²ãƒ¼ãƒ ã€‚">
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #20202d; --win: #16161d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; --dmg: #ff5555; }
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #2a2a35 0%, #000 100%);
        }

        /* èƒŒæ™¯ */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 10s infinite linear; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-bar {
            background: rgba(0,0,0,0.8); padding: 10px; border-bottom: 2px solid #fff;
            display: grid; grid-template-columns: 1fr 1fr; font-size: 14px; align-items: center; gap: 5px; z-index: 10;
        }
        .real-save-box {
            grid-column: span 2; background: #333; border-radius: 4px; padding: 5px; margin-top: 5px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #555;
        }

        /* ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--win); border: 2px solid #fff; padding: 20px; width: 85%; max-width: 400px;
            text-align: left; box-shadow: 0 0 20px var(--accent); border-radius: 8px;
        }

        /* ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ */
        .battle-stage {
            height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 10px; position: relative;
        }
        .monster-emoji { font-size: 90px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); transition: transform 0.2s; }
        .hp-box { width: 150px; height: 12px; background: #333; border: 2px solid #fff; margin-top: 10px; border-radius: 10px; overflow: hidden; display: none; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s ease-out; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message-window {
            background: rgba(22, 22, 29, 0.9); border: 2px solid #fff; border-radius: 4px;
            padding: 15px; margin-bottom: 20px; text-align: left; min-height: 80px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); font-size: 16px; line-height: 1.6;
        }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn {
            background: var(--accent); color: #fff; border: 2px solid #fff;
            padding: 15px 30px; font-size: 18px; font-family: inherit;
            cursor: pointer; border-radius: 5px; width: 100%; margin-bottom: 10px;
            box-shadow: 0 4px 0 #500; text-shadow: 1px 1px 0 #000;
            display: inline-block; box-sizing: border-box;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        /* ãƒšãƒ¼ã‚¸è¨­å®š */
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; padding-bottom: 200px; }
        .page.active { display: block; }
        
        .shop-item { background: rgba(50,50,50,0.8); border: 1px solid #777; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .zukan-item { background: rgba(30,30,40,0.8); border: 1px solid #555; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; text-align: left; font-size: 14px; }
        .zukan-emoji { font-size: 30px; margin-right: 10px; }

        /* ã‚¿ãƒ– */
        .tabs { display: flex; background: #000; border-top: 2px solid #fff; height: 60px; position: fixed; bottom: 0; width: 100%; z-index: 10; }
        .tab { flex: 1; border: none; background: #000; color: #777; font-family: inherit; font-size: 14px; cursor: pointer; border-right: 1px solid #333; }
        .tab.active { color: #fff; background: #222; font-weight: bold; border-top: 4px solid var(--accent); }

        .popup-text { position: absolute; font-size: 24px; font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 2px 2px 0 #000; z-index: 20; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }

        /* å›ºå®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */
        .fixed-action-container {
            position: fixed; bottom: 70px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            padding: 0 20px; box-sizing: border-box;
            z-index: 20;
            pointer-events: none;
        }
        .fixed-action-container > * { pointer-events: auto; }
        
        .btn-share {
            background: #1DA1F2; border-color: #fff; display: none; /* åˆæœŸéè¡¨ç¤º */
            width: 100%; max-width: 400px;
        }

    </style>
</head>
<body>

    <div class="particles" id="particles"></div>

    <div class="modal-overlay" id="tutorial-modal">
        <div class="modal-box">
            <h3 style="color:var(--gold); border-bottom:1px solid #555; padding-bottom:5px;">ğŸ° ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h3>
            <p>ã“ã®ä¸–ç•Œã§ã¯ã€ã‚ãªãŸã®<b>ã€Œãƒ¬ã‚·ãƒ¼ãƒˆã€</b>ãŒãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«å¤‰ã‚ã‚Šã¾ã™ã€‚</p>
            <button class="btn" onclick="closeTutorial()">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
        <div class="real-save-box">
            <span>ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘</span>
            <span style="color:var(--hp); font-size:16px;">Â¥ <span id="ui-save">0</span></span>
        </div>
    </div>

    <div id="page-adventure" class="page active">
        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">AIæ¥ç¶š: <span id="model-status">...</span></div>
        
        <div class="battle-stage" id="battle-stage">
            <div id="monster-emoji" class="monster-emoji">ğŸ°</div>
            <div class="hp-box" id="hp-box"><div class="hp-bar" id="hp-bar"></div></div>
            <div id="monster-name" style="margin-top:5px; font-weight:bold;"></div>
        </div>

        <div class="message-window" id="log">
            è³¢è€…ã€Œæº–å‚™ã¯ã„ã„ã‹ï¼Ÿ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ§‹ãˆã‚ã€‚ã€
        </div>
    </div>

    <div id="page-shop" class="page">
        <h3>âš”ï¸ æ­¦å™¨å±‹</h3>
        <p style="font-size:12px; color:#aaa;">å¼·ã„æ­¦å™¨ãŒãªã„ã¨é«˜é¡ãªé­”ç‰©ã¯å€’ã›ã¾ã›ã‚“</p>
        <div id="shop-list"></div>
    </div>

    <div id="page-zukan" class="page">
        <h3>ğŸ“– è¨ä¼å›³é‘‘</h3>
        <p style="font-size:12px; color:#aaa;">ã“ã‚Œã¾ã§ã«å€’ã—ãŸç„¡é§„é£ã„ãŸã¡</p>
        <div id="zukan-list">
            <div style="color:#777; margin-top:20px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <div id="fixed-action-area" class="fixed-action-container">
        <button id="share-btn" class="btn btn-share" onclick="shareTwitter()">
            ğŸ¦ å‹åˆ©ã‚’Xã§ã‚·ã‚§ã‚¢
        </button>

        <label class="btn" id="scan-btn" style="width: 100%; max-width: 400px;">
            ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
            <input type="file" accept="image/*" style="display:none" onchange="processReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">âš”ï¸ å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">ğŸ° æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">ğŸ“– å›³é‘‘</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";
        // ãƒ¢ãƒ‡ãƒ«åã‚’å®‰å…¨ç­–ã¨ã—ã¦ 'gemini-1.5-flash' ã«å›ºå®š
        const activeModel = "gemini-1.5-flash"; 

        let lastBattleResult = null; 

        const defaultData = { 
            lv: 1, gold: 0, exp: 0, realSavings: 0, weaponId: 0,
            visited: false, zukan: [] 
        };
        const weapons = [
            { id: 1, name: "ã²ã®ãã®æ£’", price: 500, atk: 1000 },
            { id: 2, name: "éŠ…ã®ã¤ã‚‹ã", price: 2500, atk: 3000 },
            { id: 3, name: "é‹¼ã®ã‚ªãƒ",   price: 5000, atk: 5000 },
            { id: 4, name: "ç‚ã®ãƒ­ãƒƒãƒ‰", price: 10000, atk: 10000 },
            { id: 5, name: "å‹‡è€…ã®å‰£",   price: 30000, atk: 999999 }
        ];

        let gameData = JSON.parse(localStorage.getItem('rd_save_v5')) || defaultData;
        let audioCtx;

        window.onload = function() {
            createParticles();
            updateUI();
            renderShop();
            renderZukan();
            
            if (!gameData.visited) {
                document.getElementById('tutorial-modal').style.display = 'flex';
            }

            const statusSpan = document.getElementById('model-status');
            statusSpan.innerText = "ONLINE";
            statusSpan.style.color = "#4ade80";
        };

        function closeTutorial() {
            document.getElementById('tutorial-modal').style.display = 'none';
            gameData.visited = true;
            saveData();
            playSound('select');
            addLog("è³¢è€…ã€Œã§ã¯ã€æœ€åˆã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ¢ã—ã¦ãã‚‹ã®ã ï¼ã€");
        }

        async function processReceipt(input) {
            if (!input.files || !input.files[0]) return;
            initAudio(); playSound('scan');
            
            // ãƒãƒˆãƒ«é–‹å§‹æ™‚ã«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’éš ã™
            document.getElementById('share-btn').style.display = 'none';

            const log = document.getElementById('log');
            const emoji = document.getElementById('monster-emoji');
            const hpBox = document.getElementById('hp-box');
            const hpBar = document.getElementById('hp-bar');
            const nameDiv = document.getElementById('monster-name');

            emoji.innerText = "â³";
            hpBox.style.display = 'none';
            nameDiv.innerText = "";
            addLog("ğŸ“¡ è§£æä¸­...");
            
            try {
                const base64 = await compressImage(input.files[0]);
                const prompt = `ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’è§£æã—ã€JSONå½¢å¼ã§ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚ã‚­ãƒ¼ã¯ amount(åˆè¨ˆé‡‘é¡ãƒ»æ•°å€¤), name(RPGé¢¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å), emoji(çµµæ–‡å­—), type(wasteã‹invest), comment(çŸ­ã„æ¯’èˆŒã‚³ãƒ¡ãƒ³ãƒˆ) ã§ã™ã€‚ä¾‹: {"amount":1000, "name":"ãƒãƒ†ãƒˆå…µ", "emoji":"ğŸ¥”", "type":"waste", "comment":"ã‚«ãƒ­ãƒªãƒ¼ã‚‚æµªè²»ã‚‚é«˜ã„ãª"}`;
                
                // é€šä¿¡å‡¦ç†
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Detail:", errorData);
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã—ãŸã€‚");
                }

                const rawText = data.candidates[0].content.parts[0].text;
                // JSONã®æ•´å½¢ï¼ˆMarkdownè¨˜æ³•ãªã©ã‚’é™¤å»ï¼‰
                const cleanText = rawText.replace(/```json|```/g, "").trim();
                let res;
                try {
                    res = JSON.parse(cleanText);
                } catch(e) {
                    console.error("JSON Parse Error:", rawText);
                    // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    res = { amount: 500, name: "è§£æä¸èƒ½ãªã‚´ãƒŸ", emoji: "ğŸ—‘ï¸", type: "waste", comment: "èª­ã¿å–ã‚Œãªã‹ã£ãŸã‚ˆã†ã ..." };
                }

                const enemyHp = res.amount || 100;
                const myWeapon = weapons.find(w => w.id === gameData.weaponId) || { name:"ç´ æ‰‹", atk: 500 };
                
                playSound('appear');
                emoji.innerText = res.emoji || "ğŸ‘¾";
                nameDiv.innerText = `${res.name} (HP:${enemyHp})`;
                hpBox.style.display = 'block';
                hpBar.style.width = '100%';
                
                addLog(`âš”ï¸ **${res.name}** ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ğŸ’¬ ${res.comment}`);

                setTimeout(() => {
                    if (myWeapon.atk >= enemyHp) {
                        playSound('attack');
                        emoji.classList.add("shake");
                        showPopup(`ğŸ’¥ ${enemyHp}`, '#ff5555');
                        hpBar.style.width = '0%';

                        setTimeout(() => {
                            playSound('win');
                            emoji.innerText = "ğŸ’€";
                            addLog(`ğŸ‰ æ’ƒç ´ï¼`);
                            
                            const savingRate = res.type === "waste" ? 0.1 : 0.05;
                            const realMoney = Math.floor(enemyHp * savingRate);
                            
                            gameData.gold += enemyHp;
                            gameData.realSavings += realMoney;
                            
                            gameData.zukan.unshift({ name: res.name, price: enemyHp, emoji: res.emoji, type: res.type });
                            if(gameData.zukan.length > 50) gameData.zukan.pop();

                            showPopup(`ğŸ’° +${enemyHp} G`, '#ffd700');
                            addLog(`ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘ +${realMoney}å††`);
                            
                            // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                            lastBattleResult = { name: res.name, price: enemyHp };
                            document.getElementById('share-btn').style.display = 'block';
                            
                            checkLevelUp();
                            saveData();
                            updateUI();
                            renderZukan();
                        }, 800);
                    } else {
                        playSound('damage');
                        addLog(`ğŸ›¡ï¸ æ­¦å™¨ãŒå¼±ã„ï¼(å¿…è¦:${enemyHp})`);
                        addLog(`ğŸƒâ€â™‚ï¸ é€ƒã’å‡ºã—ãŸ...`);
                    }
                }, 1000);

            } catch (e) {
                console.error(e);
                addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message || "é€šä¿¡ã‚¨ãƒ©ãƒ¼"}`);
            }
            input.value = "";
        }

        function shareTwitter() {
            if(!lastBattleResult) return;
            const text = `ãƒ¬ã‚·ãƒ¼ãƒˆRPGã§ã€Œ${lastBattleResult.name} (${lastBattleResult.price}G)ã€ã‚’æ’ƒç ´ï¼\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            const url = "https://receipt-dungeon.vercel.app";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            if (gameData.zukan.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555; margin-top:30px;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'zukan-item';
                div.style.borderColor = z.type === 'waste' ? '#ff5555' : '#4ade80';
                div.innerHTML = `
                    <div class="zukan-emoji">${z.emoji || 'ğŸ‘¾'}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${z.name}</div>
                        <div style="font-size:12px; color:#aaa;">${z.type==='waste'?'æµªè²»':'æŠ•è³‡'}</div>
                    </div>
                    <div style="font-weight:bold; color:var(--gold);">${z.price} G</div>
                `;
                list.appendChild(div);
            });
        }

        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.style.opacity = Math.random();
                container.appendChild(p);
            }
        }

        function checkLevelUp() {
            const nextLvExp = gameData.lv * 1000;
            gameData.exp += 100;
            if (gameData.exp >= nextLvExp) {
                gameData.lv++;
                playSound('levelup');
                showPopup(`ğŸ†™ LEVEL UP!`, '#fff');
            }
        }

        function showPopup(text, color) {
            const stage = document.getElementById('battle-stage');
            const el = document.createElement('div');
            el.className = 'popup-text';
            el.style.color = color;
            el.innerText = text;
            el.style.left = '50%';
            el.style.top = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            stage.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'select') {
                osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'appear') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(300, now + 0.3);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'scan') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'attack') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now + 0.1); osc.frequency.setValueAtTime(784, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'levelup') {
                osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(880, now + 0.1); osc.frequency.setValueAtTime(1760, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach(w => {
                const isBought = gameData.weaponId >= w.id;
                const div = document.createElement("div");
                div.className = "shop-item";
                div.style.opacity = isBought ? "0.5" : "1";
                div.innerHTML = `<div><div style="font-weight:bold;">${w.name}</div><div style="font-size:12px; color:#aaa;">ä¸Šé™ ${w.atk}å††</div></div><div style="color:${isBought?'#4ade80':'var(--gold)'}">${isBought?'æ¸ˆ':w.price+'G'}</div>`;
                if (!isBought) div.onclick = () => {
                    initAudio();
                    if (gameData.gold >= w.price && confirm("è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) {
                        gameData.gold -= w.price; gameData.weaponId = w.id;
                        playSound('win'); saveData(); updateUI(); renderShop();
                    }
                };
                list.appendChild(div);
            });
        }

        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold.toLocaleString();
            document.getElementById('ui-save').innerText = gameData.realSavings.toLocaleString();
        }
        function addLog(text) { const log = document.getElementById('log'); log.innerHTML = `<div>${text}</div>` + log.innerHTML; }
        
        function changeTab(name) {
            initAudio(); playSound('select');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + name).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const fixedArea = document.getElementById('fixed-action-area');
            if(name === 'adventure') {
                fixedArea.style.display = 'flex';
            } else {
                fixedArea.style.display = 'none';
            }
        }
        
        function saveData() { localStorage.setItem('rd_save_v5', JSON.stringify(gameData)); }
        function resetGame() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ï¼Ÿ")) { localStorage.removeItem('rd_save_v5'); location.reload(); } }
        function compressImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.onload = (e) => {
                    const img = new Image(); img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxW = 800; const scale = maxW / img.width;
                        canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
