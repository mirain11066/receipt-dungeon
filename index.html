<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #20202d; color: #fff; font-family: 'DotGothic16', sans-serif;
            margin: 0; padding: 0; text-align: center; height: 100vh; display: flex; flex-direction: column;
        }
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        #content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 200px; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status { background: #111; padding: 10px; border-bottom: 2px solid #fff; display: flex; justify-content: space-around; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn {
            background: #e94560; color: #fff; border: 2px solid #fff; padding: 10px; 
            margin: 5px 0; border-radius: 5px; cursor: pointer; display: block; width: 100%;
            font-family: inherit; font-size: 16px;
        }
        
        /* å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆæ“ä½œç›¤ï¼‰ */
        .footer-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
            border-top: 2px solid #fff; z-index: 1000; padding: 10px; box-sizing: border-box;
        }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; margin-top: 5px; }
        .tab-btn { flex: 1; background: #333; color: #aaa; border: 1px solid #555; padding: 10px; cursor: pointer; }
        .tab-btn.active { background: #e94560; color: #fff; border: 1px solid #fff; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢è¦ç´  */
        .page { display: none; }
        .page.active { display: block; }
        .emoji { font-size: 80px; margin: 20px 0; }
        .log-box { text-align: left; background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #777; height: 150px; overflow-y: scroll; font-size: 14px; }
        .hp-bar-bg { width: 100%; background: #333; height: 10px; margin: 10px 0; border: 1px solid #fff; }
        .hp-bar { width: 100%; background: #4ade80; height: 100%; transition: width 0.5s; }
        
        /* ãƒªã‚¹ãƒˆ */
        .item { border: 1px solid #555; padding: 10px; margin-bottom: 5px; background: #222; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="status">
        <div>LV.<span id="ui-lv">1</span></div>
        <div>ğŸ’°<span id="ui-gold">0</span>G</div>
        <div>ğŸ¦<span id="ui-save">0</span>å††</div>
    </div>

    <div id="content">
        <div id="page-adventure" class="page active">
            <div id="monster-area">
                <div id="monster-emoji" class="emoji">ğŸ°</div>
                <div id="monster-name" style="font-weight:bold; min-height:20px;"></div>
                <div class="hp-bar-bg"><div id="hp-bar" class="hp-bar"></div></div>
            </div>
            <div id="log" class="log-box"><div>ã‚·ã‚¹ãƒ†ãƒ : èµ·å‹•å®Œäº†</div></div>
        </div>

        <div id="page-shop" class="page">
            <h3>æ­¦å™¨å±‹</h3>
            <div id="shop-list"></div>
        </div>

        <div id="page-zukan" class="page">
            <h3>è¨ä¼å›³é‘‘</h3>
            <div id="zukan-list"></div>
        </div>
    </div>

    <div class="footer-controls">
        <button id="share-btn" class="btn" style="background:#1DA1F2; display:none;" onclick="shareTwitter()">Xã§ã‚·ã‚§ã‚¢</button>
        
        <div id="scan-container">
            <label class="btn" style="text-align:center;">
                ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
                <input type="file" accept="image/*" style="display:none" onchange="processReceipt(this)">
            </label>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('adventure')">å†’é™º</button>
            <button class="tab-btn" onclick="switchTab('shop')">æ­¦å™¨å±‹</button>
            <button class="tab-btn" onclick="switchTab('zukan')">å›³é‘‘</button>
        </div>
    </div>

    <script>
        // APIã‚­ãƒ¼è¨­å®š
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";

        // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
        let gameData = JSON.parse(localStorage.getItem('rd_save_final')) || { 
            lv: 1, gold: 0, save: 0, weapon: 0, zukan: [] 
        };
        const weapons = [
            {name:"ã²ã®ãã®æ£’", cost:500, atk:500},
            {name:"éŠ…ã®å‰£", cost:2000, atk:2000},
            {name:"é‹¼ã®å‰£", cost:5000, atk:5000},
            {name:"å‹‡è€…ã®å‰£", cost:30000, atk:50000}
        ];
        let lastBattle = null;

        // èµ·å‹•æ™‚
        window.onload = function() {
            updateUI();
            renderShop();
            renderZukan();
            addLog("ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚");
        };

        // UIæ›´æ–°
        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold;
            document.getElementById('ui-save').innerText = gameData.save;
        }

        // ãƒ­ã‚°å‡ºåŠ›
        function addLog(text) {
            const log = document.getElementById('log');
            log.innerHTML = `<div>${text}</div>` + log.innerHTML;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼ˆå˜ç´”åŒ–ï¼‰
        function switchTab(tabName) {
            // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
            document.getElementById('page-' + tabName).style.display = 'block';
            
            // ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
            document.getElementById('scan-container').style.display = (tabName === 'adventure') ? 'block' : 'none';
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆè§£æ
        async function processReceipt(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            document.getElementById('monster-emoji').innerText = "â³";
            document.getElementById('monster-name').innerText = "è§£æä¸­...";
            document.getElementById('share-btn').style.display = 'none';
            addLog("è§£æã‚’é–‹å§‹ã—ã¾ã™...");

            try {
                // ç”»åƒåœ§ç¸®
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const scale = 500 / img.width;
                            cvs.width = 500; cvs.height = img.height * scale;
                            cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                            resolve(cvs.toDataURL('image/jpeg', 0.6).split(',')[1]);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });

                // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: 'ãƒ¬ã‚·ãƒ¼ãƒˆè§£æã€‚JSONã®ã¿å‡ºåŠ›: {"name":"æ•µå","price":é‡‘é¡,"emoji":"çµµæ–‡å­—","msg":"ä¸€è¨€"}' },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ]}]
                    })
                });

                const json = await res.json();
                const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);
                const hp = data.price || 100;

                // ãƒãƒˆãƒ«æ¼”å‡º
                document.getElementById('monster-emoji').innerText = data.emoji;
                document.getElementById('monster-name').innerText = data.name;
                document.getElementById('hp-bar').style.width = '100%';
                addLog(`å‡ºç¾: ${data.name} (HP:${hp})`);
                addLog(`ã€Œ${data.msg}ã€`);

                // 1ç§’å¾Œã«æ”»æ’ƒåˆ¤å®š
                setTimeout(() => {
                    const myAtk = (weapons[gameData.weapon] ? weapons[gameData.weapon].atk : 100) + (gameData.lv * 100);
                    
                    if (myAtk >= hp) {
                        document.getElementById('hp-bar').style.width = '0%';
                        document.getElementById('monster-emoji').innerText = "ğŸ’€";
                        addLog(`å‹åˆ©ï¼ ${hp}G ç²å¾—`);
                        
                        gameData.gold += hp;
                        gameData.save += Math.floor(hp * 0.1);
                        gameData.exp = (gameData.exp || 0) + 100;
                        if(gameData.exp > gameData.lv * 1000) { gameData.lv++; addLog("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼"); }

                        gameData.zukan.unshift(data);
                        localStorage.setItem('rd_save_final', JSON.stringify(gameData));
                        
                        lastBattle = data;
                        document.getElementById('share-btn').style.display = 'block';
                        
                        updateUI();
                        renderZukan();
                    } else {
                        addLog(`æ•—åŒ—... æ”»æ’ƒåŠ›ãŒè¶³ã‚Šã¾ã›ã‚“(ATK:${myAtk})`);
                    }
                }, 1000);

            } catch(e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e);
                addLog("è§£æå¤±æ•—");
            }
            input.value = "";
        }

        // ã‚·ãƒ§ãƒƒãƒ—æç”»
        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach((w, i) => {
                const div = document.createElement('div');
                div.className = 'item';
                const bought = gameData.weapon >= i;
                div.innerHTML = `<span>${w.name} (${w.atk})</span> <span>${bought ? 'æ¸ˆ' : w.cost+'G'}</span>`;
                div.onclick = () => {
                    if(!bought && gameData.gold >= w.cost) {
                        if(confirm("è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) {
                            gameData.gold -= w.cost;
                            gameData.weapon = i;
                            updateUI(); renderShop();
                            localStorage.setItem('rd_save_final', JSON.stringify(gameData));
                        }
                    }
                };
                list.appendChild(div);
            });
        }

        // å›³é‘‘æç”»
        function renderZukan() {
            const list = document.getElementById('zukan-list');
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>${z.emoji} ${z.name}</span> <span>${z.price}G</span>`;
                list.appendChild(div);
            });
        }

        // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
        function shareTwitter() {
            if(!lastBattle) return;
            const text = `å®¶è¨ˆç°¿RPGã§ã€Œ${lastBattle.name}(${lastBattle.price}å††)ã€ã‚’æ’ƒç ´ï¼\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=https://receipt-dungeon.vercel.app`, '_blank');
        }
    </script>
</body>
</html>
