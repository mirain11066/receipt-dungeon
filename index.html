<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ | å®¶è¨ˆç°¿RPG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #20202d; --win: #16161d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; --dmg: #ff5555; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #2a2a35 0%, #000 100%);
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .status-bar {
            background: rgba(22, 22, 29, 0.95); padding: 10px; border-bottom: 2px solid #fff;
            display: grid; grid-template-columns: 1fr 1fr; font-size: 14px; align-items: center; gap: 5px; 
            z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        .real-save-box {
            grid-column: span 2; background: #333; border-radius: 4px; padding: 5px; margin-top: 5px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #555;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
        .content-area {
            flex: 1; overflow-y: auto; position: relative;
            padding: 20px; padding-bottom: 200px; /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ç”¨ã®ä½™ç™½ */
            -webkit-overflow-scrolling: touch;
        }

        /* --- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ --- */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 10s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-10vh); opacity: 0; } }

        .flash { animation: flash 0.2s; }
        @keyframes flash { 0% { background-color: transparent; } 50% { background-color: rgba(255,255,255,0.8); } 100% { background-color: transparent; } }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--win); border: 2px solid #fff; padding: 20px; width: 85%; max-width: 400px;
            text-align: left; box-shadow: 0 0 20px var(--accent); border-radius: 8px;
        }

        /* --- ãƒãƒˆãƒ«ç”»é¢ --- */
        .battle-stage {
            height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 10px; position: relative;
        }
        .monster-emoji { font-size: 90px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); transition: transform 0.1s; }
        
        .rarity-1 { color: #fff; } 
        .rarity-2 { color: #4ade80; text-shadow: 0 0 8px #4ade80; } 
        .rarity-3 { color: #a855f7; text-shadow: 0 0 12px #a855f7; } 
        .rarity-4 { color: #ffd700; text-shadow: 0 0 15px #ffd700; } 

        .hp-box { width: 150px; height: 12px; background: #333; border: 2px solid #fff; margin-top: 10px; border-radius: 10px; overflow: hidden; display: none; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s ease-out; }

        .message-window {
            background: rgba(22, 22, 29, 0.8); border: 1px solid #777; border-radius: 4px;
            padding: 15px; margin-bottom: 20px; text-align: left; min-height: 80px;
            font-size: 16px; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 4px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å›ºå®šãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆä¿®æ­£ç‰ˆï¼‰ --- */
        .fixed-action-area {
            position: fixed; bottom: 60px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            z-index: 90; padding: 10px 20px; box-sizing: border-box;
            background: linear-gradient(to top, var(--bg) 20%, transparent);
            pointer-events: none; /* ã‚¨ãƒªã‚¢è‡ªä½“ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
        }
        
        /* ç¢ºå®Ÿãªã‚¯ãƒªãƒƒã‚¯ã®ãŸã‚ã«labelã‚’ä½¿ç”¨ */
        .scan-btn {
            background: var(--accent); color: #fff; border: 2px solid #fff;
            padding: 15px 0; font-size: 18px; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 30px; width: 100%; max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-shadow: 1px 1px 0 #000;
            pointer-events: auto; /* ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .scan-btn:active { transform: scale(0.98); }

        .share-btn {
            background: #1DA1F2; color: #fff; border: 2px solid #fff; 
            padding: 10px 0; font-size: 14px; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 20px; width: 100%; max-width: 400px;
            pointer-events: auto; display: none;
            align-items: center; justify-content: center; gap: 5px;
            box-shadow: 0 4px 0 #0c85d0;
        }

        .btn {
            background: #333; color: #fff; border: 1px solid #fff;
            padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%;
        }

        /* --- ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ --- */
        .page { display: none; width: 100%; }
        .page.active { display: block; }
        
        .shop-item { background: rgba(50,50,50,0.8); border: 1px solid #777; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .zukan-item { background: rgba(30,30,40,0.8); border: 1px solid #555; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; text-align: left; font-size: 14px; }
        .zukan-emoji { font-size: 30px; margin-right: 10px; }

        /* --- ã‚¿ãƒ–ãƒãƒ¼ --- */
        .tabs { 
            display: flex; background: #000; border-top: 2px solid #fff; 
            height: 60px; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; 
        }
        .tab { 
            flex: 1; border: none; background: #000; color: #777; 
            font-family: inherit; font-size: 14px; cursor: pointer; 
            border-right: 1px solid #333; padding: 0; margin: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .tab.active { color: #fff; background: #222; font-weight: bold; border-top: 4px solid var(--accent); }

        /* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— --- */
        .popup-text { position: absolute; font-size: 30px; font-weight: bold; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 2px 2px 0 #000; z-index: 60; width: 100%; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.5); } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-10px, 5px); } 50% { transform: translate(10px, -5px); } 75% { transform: translate(-5px, 10px); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body onclick="initAudio()">

    <div class="particles" id="particles"></div>
    <div id="flash-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:95;"></div>

    <div class="modal-overlay" id="tutorial-modal">
        <div class="modal-box">
            <h3 style="color:var(--gold); border-bottom:1px solid #555; padding-bottom:5px; margin-top:0;">ğŸ° ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h3>
            <p>ä¸–ç•Œä¸­ã®ã€Œãƒ¬ã‚·ãƒ¼ãƒˆã€ãŒãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«ãªã£ã¦ã—ã¾ã£ãŸï¼</p>
            <ul style="padding-left: 20px; font-size:14px; line-height: 1.8;">
                <li>ğŸ“¸ <b>æ’®å½±:</b> ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å¬å–š</li>
                <li>âš”ï¸ <b>æˆ¦é—˜:</b> æ­¦å™¨ã‚’è²·ã£ã¦æˆ¦ãˆ</li>
                <li>ğŸ’° <b>è²¯é‡‘:</b> è¨ä¼å ±é…¬ã‚’ãƒªã‚¢ãƒ«è²¯é‡‘ã¸</li>
            </ul>
            <button class="btn" onclick="closeTutorial()">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
        <div class="real-save-box">
            <span>ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘</span>
            <span style="color:var(--hp); font-size:16px;">Â¥ <span id="ui-save">0</span></span>
        </div>
    </div>

    <div class="content-area">
        
        <div id="page-adventure" class="page active">
            <div style="font-size:12px; color:#aaa; margin-top:5px;">AIæ¥ç¶š: <span id="model-status" style="color:#4ade80">ONLINE</span></div>
            
            <div class="battle-stage" id="battle-stage">
                <div id="monster-emoji" class="monster-emoji">ğŸ°</div>
                <div class="hp-box" id="hp-box"><div class="hp-bar" id="hp-bar"></div></div>
                <div id="monster-name" style="margin-top:5px; font-weight:bold; height:20px;"></div>
            </div>

            <div class="message-window" id="log">
                <div class="log-entry">è³¢è€…ã€Œãƒ¬ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã™ã‚‹ã®ã˜ã‚ƒã€‚ã€</div>
            </div>
        </div>

        <div id="page-shop" class="page">
            <h3 style="margin:20px;">âš”ï¸ æ­¦å™¨å±‹</h3>
            <div id="shop-list"></div>
        </div>

        <div id="page-zukan" class="page">
            <h3 style="margin:20px;">ğŸ“– è¨ä¼å›³é‘‘</h3>
            <div id="zukan-list"></div>
        </div>
    </div>

    <div class="fixed-action-area" id="fixed-action-area">
        <button class="share-btn" id="share-btn" onclick="shareTwitter()">
            ğŸ¦ å‹åˆ©ã‚’å ±å‘Š (X)
        </button>

        <label class="scan-btn" id="scan-btn">
            <span>ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆå¬å–š</span>
            <input type="file" accept="image/*" style="display:none" onchange="processReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">âš”ï¸ å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">ğŸ° æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">ğŸ“– å›³é‘‘</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms"; 
        const MODEL_NAME = "gemini-1.5-flash"; // ãƒ¢ãƒ‡ãƒ«å›ºå®š

        const defaultData = { 
            lv: 1, gold: 0, exp: 0, realSavings: 0, weaponId: 0,
            visited: false, zukan: [] 
        };
        const weapons = [
            { id: 1, name: "ã²ã®ãã®æ£’", price: 500, atk: 500 },
            { id: 2, name: "éŠ…ã®ã¤ã‚‹ã", price: 2000, atk: 1500 },
            { id: 3, name: "é‹¼ã®ã‚ªãƒ",   price: 5000, atk: 3500 },
            { id: 4, name: "é­”æ³•ã®æ–",   price: 10000, atk: 8000 },
            { id: 5, name: "å‹‡è€…ã®å‰£",   price: 30000, atk: 50000 }
        ];

        let gameData = JSON.parse(localStorage.getItem('rd_save_v9')) || defaultData;
        let audioCtx;
        let lastBattleResult = null;

        window.onload = function() {
            createParticles();
            updateUI();
            renderShop();
            renderZukan();
            
            if (!gameData.visited) {
                document.getElementById('tutorial-modal').style.display = 'flex';
            }
        };

        function closeTutorial() {
            document.getElementById('tutorial-modal').style.display = 'none';
            gameData.visited = true;
            saveData();
            playSound('select');
        }

        // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        function changeTab(name) {
            playSound('select');
            
            // ãƒšãƒ¼ã‚¸è¡¨ç¤º
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById('page-' + name);
            if(targetPage) targetPage.classList.add('active');

            // ã‚¿ãƒ–è¡¨ç¤º
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ‡æ›¿
            const actionArea = document.getElementById('fixed-action-area');
            if (name === 'adventure') {
                actionArea.style.display = 'flex';
            } else {
                actionArea.style.display = 'none';
            }
        }

        // --- ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç† ---
        async function processReceipt(input) {
            if (!input.files || !input.files[0]) return;
            initAudio(); playSound('scan');
            document.getElementById('share-btn').style.display = 'none';

            const log = document.getElementById('log');
            const emoji = document.getElementById('monster-emoji');
            const hpBox = document.getElementById('hp-box');
            const hpBar = document.getElementById('hp-bar');
            const nameDiv = document.getElementById('monster-name');

            emoji.innerText = "â³";
            emoji.className = "monster-emoji";
            hpBox.style.display = 'none';
            nameDiv.innerText = "å¬å–šä¸­...";
            addLog("ğŸ“¡ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æã—ã¦ã„ã¾ã™...");
            
            try {
                const base64 = await compressImage(input.files[0]);
                const prompt = `ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’RPGã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨ã—ã¦è§£æã€‚
                JSONå‡ºåŠ›: {"amount":åˆè¨ˆé‡‘é¡, "name":"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ã®åå‰", "emoji":"çµµæ–‡å­—", "type":"waste(æµªè²»)ã‹invest(æŠ•è³‡)", "comment":"çŸ­ã„ã‚»ãƒªãƒ•"}
                ä¾‹: 3000å††ã®æœ¬â†’ã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«, 500å††ã®è“å­â†’ã‚¹ãƒ©ã‚¤ãƒ ã‚¹ãƒŠãƒƒã‚¯`;
                
                // å›ºå®šãƒ¢ãƒ‡ãƒ«ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                
                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const cleanText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const res = JSON.parse(cleanText);

                const enemyHp = res.amount || 100;
                const weaponAtk = weapons.find(w => w.id === gameData.weaponId)?.atk || 100;
                const levelBonus = gameData.lv * 50;
                let totalAtk = weaponAtk + levelBonus;
                
                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£
                let rarityClass = "rarity-1";
                if(enemyHp > 2000) rarityClass = "rarity-2";
                if(enemyHp > 5000) rarityClass = "rarity-3";
                if(enemyHp > 10000) rarityClass = "rarity-4";

                playSound('appear');
                emoji.innerText = res.emoji || "ğŸ‘¾";
                nameDiv.innerText = `${res.name}`;
                nameDiv.className = rarityClass;
                hpBox.style.display = 'block';
                hpBar.style.width = '100%';
                
                addLog(`âš”ï¸ <span class="${rarityClass}">${res.name}</span> (HP:${enemyHp}) ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ğŸ’¬ã€Œ${res.comment}ã€`);

                // ãƒãƒˆãƒ«
                setTimeout(() => {
                    let isCrit = Math.random() < 0.15;
                    if (isCrit) {
                        totalAtk *= 2;
                        playSound('crit');
                        flashScreen();
                    } else {
                        playSound('attack');
                    }

                    emoji.classList.add("shake");
                    const dmgText = isCrit ? `âš¡${totalAtk}!!` : `ğŸ’¥${totalAtk}`;
                    const dmgColor = isCrit ? '#ffd700' : '#ff5555';
                    showPopup(dmgText, dmgColor);
                    
                    if (totalAtk >= enemyHp) {
                        hpBar.style.width = '0%';
                        setTimeout(() => {
                            playSound('win');
                            emoji.innerText = "ğŸ’€";
                            
                            const savingRate = res.type === "waste" ? 0.1 : 0.05;
                            const realMoney = Math.floor(enemyHp * savingRate);
                            
                            gameData.gold += enemyHp;
                            gameData.realSavings += realMoney;
                            
                            addLog(`ğŸ‰ å‹åˆ©ï¼ ${enemyHp}G GET`);
                            
                            gameData.zukan.unshift({ name: res.name, price: enemyHp, emoji: res.emoji, type: res.type });
                            if(gameData.zukan.length > 50) gameData.zukan.pop();

                            lastBattleResult = { name: res.name, price: enemyHp };
                            document.getElementById('share-btn').style.display = 'flex'; // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤º

                            checkLevelUp();
                            saveData();
                            updateUI();
                            renderZukan();
                        }, 800);
                    } else {
                        hpBar.style.width = '80%';
                        playSound('damage');
                        addLog(`ğŸ›¡ï¸ è² ã‘ãŸ... (æ”»æ’ƒåŠ›ä¸è¶³)`);
                    }
                }, 1000);

            } catch (e) {
                console.error(e);
                addLog("âŒ è§£æå¤±æ•—ã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                emoji.innerText = "ğŸ‘»";
            }
            input.value = ""; 
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function shareTwitter() {
            if(!lastBattleResult) return;
            const text = `ãƒ¬ã‚·ãƒ¼ãƒˆRPGã§ã€Œ${lastBattleResult.name} (Â¥${lastBattleResult.price})ã€ã‚’æ’ƒç ´ï¼\nç„¡é§„é£ã„ã‚’å€’ã—ã¦è²¯é‡‘ä¸­ğŸ’°\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            const url = "https://receipt-dungeon.vercel.app";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function flashScreen() {
            const el = document.getElementById('flash-layer');
            el.className = 'flash';
            setTimeout(() => el.className = '', 200);
        }

        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold.toLocaleString();
            document.getElementById('ui-save').innerText = gameData.realSavings.toLocaleString();
        }
        function addLog(text) { 
            const log = document.getElementById('log'); 
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = text;
            log.prepend(entry);
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach(w => {
                const isBought = gameData.weaponId >= w.id;
                const div = document.createElement("div");
                div.className = "shop-item";
                div.style.opacity = isBought ? "0.5" : "1";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:${isBought?'#aaa':'#fff'}">${w.name}</div>
                        <div style="font-size:12px; color:#aaa;">ATK +${w.atk}</div>
                    </div>
                    <div class="btn" style="width:auto; background:${isBought?'#333': 'var(--accent)'}; border-color:${isBought?'#555':'#fff'}">
                        ${isBought ? 'è£…å‚™ä¸­' : w.price + 'G'}
                    </div>`;
                if (!isBought) div.onclick = () => {
                    initAudio();
                    if (gameData.gold >= w.price) {
                        if(confirm(`${w.name} ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            gameData.gold -= w.price; gameData.weaponId = w.id;
                            playSound('win'); saveData(); updateUI(); renderShop();
                        }
                    } else { alert("GãŒè¶³ã‚Šã¾ã›ã‚“"); }
                };
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            if (gameData.zukan.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555;">è¨˜éŒ²ãªã—</div>`; return;
            }
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'zukan-item';
                div.style.borderLeft = `4px solid ${z.type === 'waste' ? '#ff5555' : '#4ade80'}`;
                div.innerHTML = `<div class="zukan-emoji">${z.emoji||'ğŸ‘¾'}</div><div style="flex:1;"><div style="font-weight:bold;">${z.name}</div><div style="font-size:12px; color:#aaa;">${z.price}G</div></div>`;
                list.appendChild(div);
            });
        }

        function checkLevelUp() {
            const nextLvExp = gameData.lv * 1000;
            gameData.exp += 100;
            if (gameData.exp >= nextLvExp) {
                gameData.lv++;
                playSound('levelup');
                showPopup(`ğŸ†™ LEVEL UP!`, '#fff');
            }
        }

        function showPopup(text, color) {
            const stage = document.getElementById('battle-stage');
            const el = document.createElement('div');
            el.className = 'popup-text';
            el.style.color = color;
            el.innerText = text;
            el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
            stage.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function saveData() { localStorage.setItem('rd_save_v9', JSON.stringify(gameData)); }
        
        function createParticles() { 
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div'); p.className = 'particle';
                p.style.left = Math.random() * 100 + '%'; p.style.animationDelay = Math.random() * 5 + 's';
                p.style.opacity = Math.random(); container.appendChild(p);
            }
        }

        function initAudio() { 
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
            if (audioCtx.state === 'suspended') audioCtx.resume(); 
        }

        function playSound(type) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'scan') { osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.1, now); osc.stop(now + 0.1); }
            else if (type === 'appear') { osc.type='triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(300, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.stop(now+0.3); }
            else if (type === 'win') { osc.type='square'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now+0.1); osc.frequency.setValueAtTime(784, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4); osc.stop(now+0.4); }
            else if (type === 'crit') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now+0.2); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.2); osc.stop(now+0.2); }
            else if (type === 'damage') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.2); osc.stop(now+0.2); }
            else { osc.frequency.setValueAtTime(440, now); gain.gain.setValueAtTime(0.05, now); osc.stop(now+0.1); }
            osc.start(now);
        }

        function compressImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.onload = (e) => {
                    const img = new Image(); img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxW = 600; const scale = maxW / img.width;
                        canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
