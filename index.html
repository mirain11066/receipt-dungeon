<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #20202d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; }
        body { 
            background-color: var(--bg); color: var(--text); font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯ */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 10s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-10vh); opacity: 0; } }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .status-bar { background: rgba(0,0,0,0.8); padding: 10px; border-bottom: 2px solid #fff; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; z-index: 10; }
        .page { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 220px; display: none; }
        .page.active { display: block; }
        
        /* ãƒãƒˆãƒ«ç”»é¢ */
        .battle-stage { height: 220px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monster-emoji { font-size: 90px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .hp-bar-bg { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s; }
        .log { background: rgba(0,0,0,0.5); border: 1px solid #777; padding: 10px; text-align: left; height: 120px; overflow-y: auto; font-size: 14px; margin-top: 10px; border-radius: 4px; }
        
        /* å›ºå®šUIã‚¨ãƒªã‚¢ */
        .fixed-ui { 
            position: fixed; bottom: 70px; left: 0; width: 100%; 
            padding: 10px 20px; box-sizing: border-box; 
            display: flex; flex-direction: column; gap: 10px; align-items: center; 
            z-index: 50; pointer-events: none; /* ã‚¨ãƒªã‚¢è‡ªä½“ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
        }
        .btn { 
            background: var(--accent); color: #fff; border: 2px solid #fff; padding: 15px; 
            width: 100%; max-width: 400px; font-size: 16px; font-weight: bold; 
            cursor: pointer; pointer-events: auto; border-radius: 30px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }
        .btn-share { background: #1DA1F2; display: none; }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; background: #000; height: 60px; position: fixed; bottom: 0; width: 100%; border-top: 2px solid #fff; z-index: 60; }
        .tab { flex: 1; background: #000; color: #777; border: none; border-right: 1px solid #333; font-size: 14px; font-family: inherit; cursor: pointer; }
        .tab.active { color: #fff; background: #222; border-top: 4px solid var(--accent); font-weight: bold; }
        
        /* ãƒªã‚¹ãƒˆ */
        .item { border: 1px solid #555; padding: 12px; margin-bottom: 8px; background: rgba(50,50,50,0.6); display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¼”å‡º */
        .popup-text { position: absolute; font-size: 30px; font-weight: bold; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 2px 2px 0 #000; z-index: 100; width: 100%; left: 50%; transform: translateX(-50%); }
        @keyframes floatUp { 0% { top: 40%; opacity: 1; } 100% { top: 20%; opacity: 0; } }
    </style>
</head>
<body>

    <div class="particles" id="particles"></div>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
    </div>

    <div id="page-adventure" class="page active">
        <div class="battle-stage">
            <div id="m-emoji" class="monster-emoji">ğŸ°</div>
            <div id="m-name" style="font-weight:bold; margin-top:5px; height: 24px;"></div>
            <div class="hp-bar-bg" id="hp-box" style="display:none"><div id="hp-bar" class="hp-bar"></div></div>
        </div>
        <div id="log" class="log">
            <div>ã‚·ã‚¹ãƒ†ãƒ : æ¥ç¶šå®Œäº†</div>
            <div>è³¢è€…ã€Œä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å¬å–šã›ã‚ˆã€</div>
        </div>
    </div>

    <div id="page-shop" class="page">
        <h3 style="margin:10px 0;">æ­¦å™¨å±‹</h3>
        <div id="shop-list"></div>
    </div>

    <div id="page-zukan" class="page">
        <h3 style="margin:10px 0;">è¨ä¼å›³é‘‘</h3>
        <div id="zukan-list"></div>
    </div>

    <div id="fixed-ui" class="fixed-ui">
        <button id="btn-share" class="btn btn-share" onclick="shareTwitter()">
            ğŸ¦ å‹åˆ©ã‚’Xã§ã‚·ã‚§ã‚¢
        </button>
        <label class="btn" id="btn-scan">
            ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
            <input type="file" accept="image/*" style="display:none" onchange="scanReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">å›³é‘‘</button>
    </div>

    <script>
        // â˜…é‡è¦: APIã‚­ãƒ¼ç®¡ç†
        // ã‚³ãƒ¼ãƒ‰å†…ã®ã‚­ãƒ¼ãŒç„¡åŠ¹ãªå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™
        let API_KEY = localStorage.getItem('rd_api_key') || "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";
        const MODEL_NAME = "gemini-1.5-flash"; // å®‰å®šæ¿ãƒ¢ãƒ‡ãƒ«å›ºå®š

        let data = JSON.parse(localStorage.getItem('rd_save_v7')) || { lv:1, gold:0, weapon:0, zukan:[], realSave:0 };
        let lastBattle = null;

        const weapons = [
            {name:"ã²ã®ãã®æ£’", cost:500, atk:500},
            {name:"éŠ…ã®å‰£", cost:2000, atk:2000},
            {name:"é‹¼ã®å‰£", cost:5000, atk:5000},
            {name:"å‹‡è€…ã®å‰£", cost:30000, atk:50000}
        ];

        window.onload = () => { 
            createParticles();
            updateUI(); 
            renderShop(); 
            renderZukan();
        };

        // --- ãƒ¬ã‚·ãƒ¼ãƒˆè§£æå‡¦ç† (ä¿®æ­£ç‰ˆ) ---
        async function scanReceipt(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            
            // UIãƒªã‚»ãƒƒãƒˆ
            document.getElementById('m-emoji').innerText = "â³";
            document.getElementById('m-name').innerText = "è§£æä¸­...";
            document.getElementById('hp-box').style.display = "none";
            document.getElementById('btn-share').style.display = "none";
            addLog("ğŸ“¡ ç”»åƒã‚’é€ä¿¡ä¸­...");

            try {
                // 1. ç”»åƒåœ§ç¸®
                const base64 = await compressImage(file);

                // 2. AIé€šä¿¡ (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–)
                const prompt = `ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’è§£æã€‚JSONã®ã¿å‡ºåŠ›: {"amount":åˆè¨ˆé‡‘é¡(æ•°å€¤),"name":"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å","emoji":"çµµæ–‡å­—","msg":"ä¸€è¨€"}`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {text: prompt},
                                {inline_data: {mime_type: "image/jpeg", data: base64}}
                            ]
                        }]
                    })
                });

                // 3. é€šä¿¡ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (!response.ok) {
                    if (response.status === 400 || response.status === 403) {
                        const newKey = prompt("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„Google Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
                        if(newKey) {
                            API_KEY = newKey;
                            localStorage.setItem('rd_api_key', newKey);
                            addLog("ğŸ”„ ã‚­ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
                        } else {
                            addLog("âŒ APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚");
                        }
                        throw new Error("API Key Error");
                    }
                    throw new Error(`Server Error: ${response.status}`);
                }

                const json = await response.json();
                if(!json.candidates) throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™");

                const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const result = JSON.parse(text);
                
                const hp = result.amount || 100;
                
                // ãƒãƒˆãƒ«é–‹å§‹
                document.getElementById('m-emoji').innerText = result.emoji;
                document.getElementById('m-name').innerText = `${result.name} (HP:${hp})`;
                document.getElementById('hp-box').style.display = "block";
                document.getElementById('hp-bar').style.width = "100%";
                addLog(`âš”ï¸ **${result.name}** ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ğŸ’¬ ã€Œ${result.msg}ã€`);

                // æˆ¦é—˜æ¼”å‡º
                setTimeout(() => {
                    const myAtk = (weapons[data.weapon]?.atk || 500) + (data.lv * 100);
                    
                    if(myAtk >= hp) {
                        document.getElementById('hp-bar').style.width = "0%";
                        showPopup(`ğŸ’¥ ${myAtk}`, '#ff5555');
                        
                        setTimeout(() => {
                            document.getElementById('m-emoji').innerText = "ğŸ’€";
                            addLog(`ğŸ‰ å‹åˆ©ï¼ ${hp}G GET`);
                            
                            data.gold += hp;
                            data.realSave += Math.floor(hp * 0.1);
                            data.zukan.unshift(result);
                            localStorage.setItem('rd_save_v7', JSON.stringify(data));
                            
                            // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤º
                            lastBattle = result;
                            document.getElementById('btn-share').style.display = "block";
                            
                            checkLevelUp();
                            updateUI(); 
                            renderZukan();
                        }, 800);
                    } else {
                        showPopup(`ğŸ›¡ï¸ é˜²ãŒã‚ŒãŸï¼`, '#aaa');
                        addLog(`ğŸ’€ æ•—åŒ—... (æ”»æ’ƒåŠ›ä¸è¶³: ${myAtk})`);
                    }
                }, 1200);

            } catch(e) {
                console.error(e);
                if(e.message !== "API Key Error") {
                    addLog("âŒ è§£æå¤±æ•—: " + e.message);
                    document.getElementById('m-emoji').innerText = "ğŸ‘¾";
                    document.getElementById('m-name').innerText = "ã‚¨ãƒ©ãƒ¼";
                }
            }
            input.value = "";
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function updateUI() {
            document.getElementById('ui-lv').innerText = data.lv;
            document.getElementById('ui-gold').innerText = data.gold.toLocaleString();
        }
        
        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML = `<div style="border-bottom:1px dashed #444; padding:4px;">${msg}</div>` + log.innerHTML;
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach((w, i) => {
                const div = document.createElement('div');
                div.className = "item";
                const bought = data.weapon >= i;
                div.innerHTML = `
                    <div><b>${w.name}</b> <small>(ATK:${w.atk})</small></div>
                    <div style="color:${bought?'#4ade80':'#ffd700'}">${bought?'æ¸ˆ':w.cost+'G'}</div>`;
                if(!bought) {
                    div.onclick = () => {
                        if(data.gold >= w.cost) {
                            if(confirm("è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) {
                                data.gold -= w.cost; data.weapon = i;
                                updateUI(); renderShop();
                                localStorage.setItem('rd_save_v7', JSON.stringify(data));
                            }
                        } else { alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“"); }
                    };
                }
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            list.innerHTML = "";
            if(data.zukan.length === 0) list.innerHTML = "<div style='text-align:center;color:#777'>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
            data.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<span>${z.emoji} ${z.name}</span> <span>${z.amount}G</span>`;
                list.appendChild(div);
            });
        }

        function changeTab(name) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+name).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');

            const fixed = document.getElementById('fixed-ui');
            fixed.style.display = (name === 'adventure') ? 'flex' : 'none';
        }

        function shareTwitter() {
            if(!lastBattle) return;
            const text = `ãƒ¬ã‚·ãƒ¼ãƒˆRPGã§ã€Œ${lastBattle.name}(${lastBattle.amount}G)ã€ã‚’æ’ƒç ´ï¼\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=https://receipt-dungeon.vercel.app`, '_blank');
        }

        function checkLevelUp() {
            const nextExp = data.lv * 1000;
            if(data.gold > nextExp) { // ç°¡æ˜“çš„ãªãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¡ä»¶
                data.lv++;
                showPopup("ğŸ†™ LEVEL UP!", "#ffd700");
            }
        }

        function showPopup(text, color) {
            const el = document.createElement('div');
            el.className = 'popup-text';
            el.style.color = color;
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.style.opacity = Math.random();
                container.appendChild(p);
            }
        }

        function compressImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.onload = (e) => {
                    const img = new Image(); img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxW = 800; const scale = maxW / img.width;
                        canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
