<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #20202d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; }
        body { 
            background-color: var(--bg); color: var(--text); font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .status-bar { background: rgba(0,0,0,0.8); padding: 10px; border-bottom: 2px solid #fff; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .page { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 180px; display: none; }
        .page.active { display: block; }
        .battle-stage { height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .monster-emoji { font-size: 80px; }
        .hp-bar-bg { width: 150px; height: 10px; background: #333; border: 1px solid #fff; margin-top: 5px; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s; }
        .log { background: rgba(0,0,0,0.5); border: 1px solid #777; padding: 10px; text-align: left; height: 100px; overflow-y: auto; font-size: 14px; margin-top: 10px; }
        
        /* å›ºå®šã‚¨ãƒªã‚¢ */
        .fixed-ui { position: fixed; bottom: 70px; left: 0; width: 100%; padding: 0 20px; box-sizing: border-box; pointer-events: none; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn { background: var(--accent); color: #fff; border: 2px solid #fff; padding: 15px; width: 100%; max-width: 400px; font-size: 16px; font-weight: bold; cursor: pointer; pointer-events: auto; border-radius: 5px; text-align: center; }
        .btn-share { background: #1DA1F2; display: none; }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; background: #000; height: 60px; position: fixed; bottom: 0; width: 100%; border-top: 2px solid #fff; }
        .tab { flex: 1; background: #000; color: #777; border: none; border-right: 1px solid #333; font-size: 14px; }
        .tab.active { color: #fff; background: #222; border-top: 4px solid var(--accent); }
        
        /* ãƒªã‚¹ãƒˆ */
        .item { border: 1px solid #555; padding: 10px; margin-bottom: 5px; background: rgba(50,50,50,0.5); display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
    </div>

    <div id="page-adventure" class="page active">
        <div class="battle-stage">
            <div id="m-emoji" class="monster-emoji">ğŸ°</div>
            <div id="m-name" style="font-weight:bold; margin-top:5px;"></div>
            <div class="hp-bar-bg" id="hp-box" style="display:none"><div id="hp-bar" class="hp-bar"></div></div>
        </div>
        <div id="log" class="log"><div>ã‚·ã‚¹ãƒ†ãƒ : æº–å‚™å®Œäº† (Model: Flash)</div></div>
    </div>

    <div id="page-shop" class="page">
        <h3>æ­¦å™¨å±‹</h3>
        <div id="shop-list"></div>
    </div>

    <div id="page-zukan" class="page">
        <h3>å›³é‘‘</h3>
        <div id="zukan-list"></div>
    </div>

    <div id="fixed-ui" class="fixed-ui">
        <button id="btn-share" class="btn btn-share" onclick="shareTwitter()">ğŸ¦ Xã§ã‚·ã‚§ã‚¢</button>
        <label class="btn">
            ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
            <input type="file" accept="image/*" style="display:none" onchange="scanReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">å›³é‘‘</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";
        // â˜…ã“ã“ã‚’ä¿®æ­£ï¼šgemini-1.5-flashã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
        const MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        
        let data = JSON.parse(localStorage.getItem('rd_save_v6')) || { lv:1, gold:0, weapon:0, zukan:[] };
        let lastBattle = null;

        const weapons = [
            {name:"ã²ã®ãã®æ£’", cost:500, atk:500},
            {name:"éŠ…ã®å‰£", cost:2000, atk:2000},
            {name:"é‹¼ã®å‰£", cost:5000, atk:5000},
            {name:"å‹‡è€…ã®å‰£", cost:30000, atk:99999}
        ];

        window.onload = () => { updateUI(); renderShop(); renderZukan(); };

        async function scanReceipt(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            
            // UIãƒªã‚»ãƒƒãƒˆ
            document.getElementById('m-emoji').innerText = "â³";
            document.getElementById('m-name').innerText = "è§£æä¸­...";
            document.getElementById('hp-box').style.display = "none";
            document.getElementById('btn-share').style.display = "none";
            addLog("ğŸ“¡ è§£æã‚’é–‹å§‹ã—ã¾ã™...");

            try {
                // ç”»åƒåœ§ç¸®
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const maxW = 800;
                            const scale = maxW / img.width;
                            cvs.width = maxW; cvs.height = img.height * scale;
                            cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                            resolve(cvs.toDataURL('image/jpeg', 0.7).split(',')[1]);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });

                // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const res = await fetch(MODEL_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {text: 'ãƒ¬ã‚·ãƒ¼ãƒˆè§£æã€‚JSONã®ã¿å‡ºåŠ›: {"amount":åˆè¨ˆé‡‘é¡,"name":"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å","emoji":"çµµæ–‡å­—","msg":"ä¸€è¨€"}'},
                                {inline_data: {mime_type: "image/jpeg", data: base64}}
                            ]
                        }]
                    })
                });

                const json = await res.json();
                
                // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if(!json.candidates) {
                    console.error(json);
                    throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™");
                }

                const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const result = JSON.parse(text);
                
                const hp = result.amount || 100;
                
                // ãƒãƒˆãƒ«é–‹å§‹
                document.getElementById('m-emoji').innerText = result.emoji;
                document.getElementById('m-name').innerText = result.name;
                document.getElementById('hp-box').style.display = "block";
                document.getElementById('hp-bar').style.width = "100%";
                addLog(`âš”ï¸ ${result.name} (HP:${hp}) ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ã€Œ${result.msg}ã€`);

                setTimeout(() => {
                    const myAtk = (weapons[data.weapon]?.atk || 500) + (data.lv * 100);
                    
                    if(myAtk >= hp) {
                        document.getElementById('hp-bar').style.width = "0%";
                        document.getElementById('m-emoji').innerText = "ğŸ’€";
                        addLog(`ğŸ‰ å‹åˆ©ï¼ ${hp}G GET`);
                        
                        data.gold += hp;
                        data.zukan.unshift(result);
                        localStorage.setItem('rd_save_v6', JSON.stringify(data));
                        
                        lastBattle = result;
                        document.getElementById('btn-share').style.display = "block";
                        
                        updateUI(); renderZukan();
                    } else {
                        addLog(`ğŸ›¡ï¸ æ•—åŒ—... (ATKä¸è¶³: ${myAtk})`);
                    }
                }, 1000);

            } catch(e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
                addLog("âŒ è§£æå¤±æ•—");
            }
            input.value = "";
        }

        function updateUI() {
            document.getElementById('ui-lv').innerText = data.lv;
            document.getElementById('ui-gold').innerText = data.gold;
        }
        
        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach((w, i) => {
                const div = document.createElement('div');
                div.className = "item";
                const bought = data.weapon >= i;
                div.innerHTML = `<span>${w.name} (${w.atk})</span> <span style="color:${bought?'#4ade80':'#ffd700'}">${bought?'æ¸ˆ':w.cost+'G'}</span>`;
                if(!bought) {
                    div.onclick = () => {
                        if(data.gold >= w.cost && confirm("è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) {
                            data.gold -= w.cost; data.weapon = i;
                            updateUI(); renderShop();
                            localStorage.setItem('rd_save_v6', JSON.stringify(data));
                        }
                    };
                }
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            list.innerHTML = "";
            data.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = "item";
                div.innerHTML = `<span>${z.emoji} ${z.name}</span> <span>${z.amount}G</span>`;
                list.appendChild(div);
            });
        }

        function changeTab(name) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+name).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');

            const fixed = document.getElementById('fixed-ui');
            fixed.style.display = (name === 'adventure') ? 'flex' : 'none';
        }

        function shareTwitter() {
            if(!lastBattle) return;
            const text = `ãƒ¬ã‚·ãƒ¼ãƒˆRPGã§ã€Œ${lastBattle.name}(${lastBattle.amount}G)ã€ã‚’æ’ƒç ´ï¼\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=https://receipt-dungeon.vercel.app`, '_blank');
        }
    </script>
</body>
</html>
