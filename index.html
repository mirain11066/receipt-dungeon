<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #20202d; color: #fff; font-family: 'DotGothic16', sans-serif;
            margin: 0; padding: 0; text-align: center; height: 100vh; display: flex; flex-direction: column;
        }
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        #content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 220px; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status { background: #111; padding: 10px; border-bottom: 2px solid #fff; display: flex; justify-content: space-around; font-size: 14px;}
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn {
            background: #e94560; color: #fff; border: 2px solid #fff; padding: 12px; 
            margin: 5px 0; border-radius: 5px; cursor: pointer; display: block; width: 100%;
            font-family: inherit; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 0 #500;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #500; }
        
        /* å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9);
            border-top: 1px solid #555; z-index: 1000; padding: 15px; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; gap: 5px; }
        .tab-btn { flex: 1; background: #333; color: #aaa; border: 1px solid #555; padding: 10px; cursor: pointer; border-radius: 5px;}
        .tab-btn.active { background: #444; color: #fff; border: 1px solid #fff; }

        /* ç”»é¢è¦ç´  */
        .page { display: none; }
        .page.active { display: block; }
        .emoji { font-size: 80px; margin: 10px 0; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .log-box { text-align: left; background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #777; height: 120px; overflow-y: auto; font-size: 14px; margin-top:10px; }
        .hp-bar-bg { width: 100%; background: #333; height: 12px; margin: 10px 0; border: 2px solid #fff; border-radius: 6px; overflow: hidden;}
        .hp-bar { width: 100%; background: #4ade80; height: 100%; transition: width 0.3s; }
        
        /* ãƒªã‚¹ãƒˆ */
        .item { border: 1px solid #555; padding: 12px; margin-bottom: 8px; background: #2a2a35; display: flex; justify-content: space-between; border-radius: 4px;}
    </style>
</head>
<body>

    <div class="status">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:#ffd700">ğŸ’°<span id="ui-gold">0</span>G</div>
        <div style="color:#4ade80">ğŸ¦<span id="ui-save">0</span>å††</div>
    </div>

    <div id="content">
        <div id="page-adventure" class="page active">
            <div id="monster-area">
                <div id="monster-emoji" class="emoji">ğŸ°</div>
                <div id="monster-name" style="font-weight:bold; min-height:20px; font-size:18px;"></div>
                <div class="hp-bar-bg"><div id="hp-bar" class="hp-bar"></div></div>
            </div>
            <div id="log" class="log-box"><div>ã‚·ã‚¹ãƒ†ãƒ : èµ·å‹•</div></div>
        </div>

        <div id="page-shop" class="page">
            <h3>âš”ï¸ æ­¦å™¨å±‹</h3>
            <div id="shop-list"></div>
        </div>

        <div id="page-zukan" class="page">
            <h3>ğŸ“– è¨ä¼å›³é‘‘</h3>
            <div id="zukan-list"></div>
        </div>
    </div>

    <div class="footer-controls">
        <button id="share-btn" class="btn" style="background:#1DA1F2; border-color:#fff; display:none;" onclick="shareTwitter()">
            ğŸ¦ å‹åˆ©ã‚’Xã§ã‚·ã‚§ã‚¢
        </button>
        
        <div id="scan-container">
            <label class="btn" style="text-align:center; margin:0;">
                ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
                <input type="file" accept="image/*" style="display:none" onchange="processReceipt(this)">
            </label>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('adventure')">å†’é™º</button>
            <button class="tab-btn" onclick="switchTab('shop')">æ­¦å™¨å±‹</button>
            <button class="tab-btn" onclick="switchTab('zukan')">å›³é‘‘</button>
        </div>
    </div>

    <script>
        // â˜…é‡è¦: ã“ã“ã«è‡ªåˆ†ã®APIã‚­ãƒ¼ã‚’å…¥ã‚Œã¦ãã ã•ã„
        let API_KEY = localStorage.getItem('rd_api_key') || "";
        
        // ä½¿ç”¨ãƒ¢ãƒ‡ãƒ« (404å¯¾ç­–ã§ä¸€èˆ¬çš„ãªãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨)
        const MODEL = "gemini-1.5-flash"; 

        let gameData = JSON.parse(localStorage.getItem('rd_save_final2')) || { 
            lv: 1, gold: 0, save: 0, weapon: 0, exp: 0, zukan: [] 
        };
        const weapons = [
            {name:"ã²ã®ãã®æ£’", cost:500, atk:500},
            {name:"éŠ…ã®å‰£", cost:2000, atk:2000},
            {name:"é‹¼ã®å‰£", cost:5000, atk:5000},
            {name:"å‹‡è€…ã®å‰£", cost:30000, atk:50000}
        ];
        let lastBattle = null;

        window.onload = function() {
            // APIã‚­ãƒ¼ãŒãªã„å ´åˆã€å…¥åŠ›ã‚’æ±‚ã‚ã‚‹
            if(!API_KEY || API_KEY.length < 10) {
                const inputKey = prompt("Google Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n(ä¸æ˜ãªå ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰)");
                if(inputKey) {
                    API_KEY = inputKey;
                    localStorage.setItem('rd_api_key', API_KEY);
                }
            }
            updateUI();
            renderShop();
            renderZukan();
            addLog("ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚");
        };

        function switchTab(tabName) {
            document.querySelectorAll('.page').forEach(el => el.style.display = 'none');
            document.getElementById('page-' + tabName).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const scanContainer = document.getElementById('scan-container');
            if(tabName === 'adventure') {
                scanContainer.style.display = 'block';
            } else {
                scanContainer.style.display = 'none';
            }
        }

        async function processReceipt(input) {
            if (!input.files || !input.files[0]) return;
            if (!API_KEY) { alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

            const file = input.files[0];
            const emojiEl = document.getElementById('monster-emoji');
            const nameEl = document.getElementById('monster-name');
            
            emojiEl.innerText = "â³";
            nameEl.innerText = "è§£æä¸­...";
            document.getElementById('share-btn').style.display = 'none';
            addLog("ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ä¸­...");

            try {
                // ç”»åƒåœ§ç¸®
                const base64 = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const maxW = 800;
                            const scale = maxW / img.width;
                            cvs.width = maxW; cvs.height = img.height * scale;
                            cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                            resolve(cvs.toDataURL('image/jpeg', 0.6).split(',')[1]);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });

                // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: 'ãƒ¬ã‚·ãƒ¼ãƒˆè§£æã€‚JSONã®ã¿å‡ºåŠ›: {"name":"RPGé¢¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å","price":åˆè¨ˆé‡‘é¡(æ•°å€¤),"emoji":"çµµæ–‡å­—","msg":"ä¸€è¨€"}' },
                            { inline_data: { mime_type: "image/jpeg", data: base64 } }
                        ]}]
                    })
                });

                if (!res.ok) {
                    if(res.status === 404) throw new Error("ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“(404)ã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                    throw new Error(`API Error: ${res.status}`);
                }

                const json = await res.json();
                if(!json.candidates) throw new Error("è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ");

                const text = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);
                const hp = data.price || 100;

                // ãƒãƒˆãƒ«é–‹å§‹
                emojiEl.innerText = data.emoji;
                nameEl.innerText = data.name;
                document.getElementById('hp-bar').style.width = '100%';
                addLog(`âš”ï¸ ${data.name} (HP:${hp}) ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ã€Œ${data.msg}ã€`);

                // æ”»æ’ƒå‡¦ç†
                setTimeout(() => {
                    const myWeapon = weapons[gameData.weapon];
                    const myAtk = (myWeapon ? myWeapon.atk : 500) + (gameData.lv * 100);
                    
                    if (myAtk >= hp) {
                        // å‹åˆ©
                        document.getElementById('hp-bar').style.width = '0%';
                        emojiEl.innerText = "ğŸ’€";
                        addLog(`ğŸ‰ æ’ƒç ´ï¼ ${hp}G ç²å¾—`);
                        
                        gameData.gold += hp;
                        gameData.save += Math.floor(hp * 0.1);
                        gameData.exp += 100;
                        if(gameData.exp >= gameData.lv * 1000) { gameData.lv++; addLog("ğŸ†™ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼"); }

                        gameData.zukan.unshift(data);
                        localStorage.setItem('rd_save_final2', JSON.stringify(gameData));
                        
                        lastBattle = data;
                        document.getElementById('share-btn').style.display = 'block'; // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¡¨ç¤º
                        
                        updateUI();
                        renderZukan();
                    } else {
                        // æ•—åŒ—
                        addLog(`ğŸ›¡ï¸ è² ã‘ãŸ... (ATK:${myAtk} < HP:${hp})`);
                        document.getElementById('hp-bar').style.width = '80%';
                    }
                }, 1000);

            } catch(e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
                nameEl.innerText = "";
                emojiEl.innerText = "ğŸ°";
                addLog("âŒ è§£æå¤±æ•—");
            }
            input.value = "";
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach((w, i) => {
                const div = document.createElement('div');
                div.className = 'item';
                const bought = gameData.weapon >= i;
                div.innerHTML = `
                    <div><b>${w.name}</b> <small>(ATK:${w.atk})</small></div>
                    <div style="color:${bought?'#4ade80':'#ffd700'}">${bought ? 'è³¼å…¥æ¸ˆ' : w.cost+'G'}</div>
                `;
                if(!bought) {
                    div.onclick = () => {
                        if(gameData.gold >= w.cost) {
                            if(confirm("è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) {
                                gameData.gold -= w.cost;
                                gameData.weapon = i;
                                updateUI(); renderShop();
                                localStorage.setItem('rd_save_final2', JSON.stringify(gameData));
                            }
                        } else { alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“"); }
                    };
                }
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<span>${z.emoji} ${z.name}</span> <span>${z.price}G</span>`;
                list.appendChild(div);
            });
        }

        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold.toLocaleString();
            document.getElementById('ui-save').innerText = gameData.save.toLocaleString();
        }

        function addLog(text) {
            const log = document.getElementById('log');
            log.innerHTML = `<div style="border-bottom:1px dashed #444; padding:4px;">${text}</div>` + log.innerHTML;
        }

        function shareTwitter() {
            if(!lastBattle) return;
            const text = `å®¶è¨ˆç°¿RPGã€ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã€ã§\nã€Œ${lastBattle.name} (Â¥${lastBattle.price})ã€ã‚’æ’ƒç ´ï¼\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            const url = "https://receipt-dungeon.vercel.app";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }
    </script>
</body>
</html>
