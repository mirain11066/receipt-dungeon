<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ | å®¶è¨ˆç°¿RPG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #20202d; --win: #16161d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; --dmg: #ff5555; }
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #2a2a35 0%, #000 100%);
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .status-bar {
            background: rgba(22, 22, 29, 0.95); padding: 10px; border-bottom: 2px solid #fff;
            display: grid; grid-template-columns: 1fr 1fr; font-size: 14px; align-items: center; gap: 5px; 
            z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        
        .real-save-box {
            grid-column: span 2; background: #333; border-radius: 4px; padding: 5px; margin-top: 5px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #555;
        }

        .content-area {
            flex: 1; overflow-y: auto; position: relative;
            padding-bottom: 150px; -webkit-overflow-scrolling: touch;
        }

        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 10s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-10vh); opacity: 0; } }

        /* --- ãƒãƒˆãƒ«æ¼”å‡º --- */
        .battle-stage {
            height: 220px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-top: 10px; margin-bottom: 10px; position: relative;
        }
        .monster-emoji { font-size: 90px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); transition: transform 0.1s; }
        
        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ */
        .rarity-1 { color: #fff; text-shadow: 0 0 5px #fff; } /* Normal */
        .rarity-2 { color: #4ade80; text-shadow: 0 0 10px #4ade80; } /* Rare */
        .rarity-3 { color: #a855f7; text-shadow: 0 0 15px #a855f7; } /* Epic */
        .rarity-4 { color: #ffd700; text-shadow: 0 0 20px #ffd700; } /* Legendary */

        .hp-box { width: 150px; height: 12px; background: #333; border: 2px solid #fff; margin-top: 10px; border-radius: 10px; overflow: hidden; display: none; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s ease-out; }

        .message-window {
            background: rgba(22, 22, 29, 0.8); border: 1px solid #777; border-radius: 4px;
            padding: 15px; margin: 0 20px 20px 20px; text-align: left; min-height: 80px;
            font-size: 16px; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 4px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ãƒœã‚¿ãƒ³é¡ --- */
        .fixed-scan-container {
            position: fixed; bottom: 70px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 40; padding: 0 20px; box-sizing: border-box;
            background: linear-gradient(to top, var(--bg) 40%, transparent);
            pointer-events: none;
        }
        
        .scan-btn {
            background: var(--accent); color: #fff; border: 2px solid #fff;
            padding: 15px 0; font-size: 18px; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 30px; width: 100%; max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-shadow: 1px 1px 0 #000;
            pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .scan-btn:active { transform: scale(0.98); }

        .share-btn {
            background: #1DA1F2; color: #fff; border: 2px solid #fff; margin-bottom: 10px;
            padding: 10px 0; font-size: 14px; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 20px; width: 100%; max-width: 400px;
            pointer-events: auto; display: none; /* åˆæœŸã¯éè¡¨ç¤º */
            align-items: center; justify-content: center; gap: 5px;
            box-shadow: 0 4px 0 #0c85d0;
        }
        .share-btn:active { transform: translateY(4px); box-shadow: none; }

        .btn {
            background: #333; color: #fff; border: 1px solid #fff;
            padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%;
        }

        .page { display: none; }
        .page.active { display: block; }
        
        .shop-item { background: rgba(50,50,50,0.8); border: 1px solid #777; padding: 15px; margin: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .zukan-item { background: rgba(30,30,40,0.8); border: 1px solid #555; padding: 10px; margin: 5px 20px; display: flex; align-items: center; text-align: left; font-size: 14px; }
        .zukan-emoji { font-size: 30px; margin-right: 10px; }

        .tabs { display: flex; background: #000; border-top: 2px solid #fff; height: 60px; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; }
        .tab { flex: 1; border: none; background: #000; color: #777; font-family: inherit; font-size: 14px; cursor: pointer; border-right: 1px solid #333; }
        .tab.active { color: #fff; background: #222; font-weight: bold; border-top: 4px solid var(--accent); }

        .popup-text { position: absolute; font-size: 30px; font-weight: bold; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 2px 2px 0 #000; z-index: 60; width: 100%; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.5); } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-10px, 5px); } 50% { transform: translate(10px, -5px); } 75% { transform: translate(-5px, 10px); } 100% { transform: translate(0, 0); } }
        
        .flash { animation: flash 0.2s; }
        @keyframes flash { 0% { background-color: transparent; } 50% { background-color: rgba(255,255,255,0.8); } 100% { background-color: transparent; } }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div id="flash-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:100;"></div>

    <div class="modal-overlay" id="tutorial-modal" style="display:none;">
        <div class="modal-box">
            <h3 style="color:var(--gold); border-bottom:1px solid #555; padding-bottom:5px;">ğŸ° ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h3>
            <p>v1.2 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼</p>
            <ul style="padding-left: 20px; font-size:14px; line-height: 1.8;">
                <li>ğŸ“¸ <b>æ’®å½±:</b> ãƒ¬ã‚·ãƒ¼ãƒˆãŒé­”ç‰©ã«å¤‰åŒ–</li>
                <li>ğŸ†™ <b>æˆé•·:</b> ãƒ¬ãƒ™ãƒ«UPã§åŸºç¤æ”»æ’ƒåŠ›ä¸Šæ˜‡</li>
                <li>âš¡ <b>ä¼šå¿ƒ:</b> é‹ãŒè‰¯ã‘ã‚Œã°å¼·æ•µã‚‚ä¸€æ’ƒï¼</li>
                <li>ğŸ’° <b>è²¯é‡‘:</b> æµ®ã„ãŸãŠé‡‘ã‚’è¨˜éŒ²ã—ã‚ˆã†</li>
            </ul>
            <button class="scan-btn" onclick="closeTutorial()" style="width:100%; font-size:16px;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
        <div class="real-save-box">
            <span>ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘</span>
            <span style="color:var(--hp); font-size:16px;">Â¥ <span id="ui-save">0</span></span>
        </div>
    </div>

    <div class="content-area">
        <div id="page-adventure" class="page active">
            <div style="font-size:12px; color:#aaa; margin-top:5px;">AI: <span id="model-status">...</span></div>
            
            <div class="battle-stage" id="battle-stage">
                <div id="monster-emoji" class="monster-emoji">ğŸ°</div>
                <div class="hp-box" id="hp-box"><div class="hp-bar" id="hp-bar"></div></div>
                <div id="monster-name" style="margin-top:5px; font-weight:bold; height:20px;"></div>
            </div>

            <div class="message-window" id="log">
                <div class="log-entry">è³¢è€…ã€Œãƒ¬ã‚·ãƒ¼ãƒˆãŒä¸–ç•Œã‚’æ•‘ã†...ã‹ã‚‚ã—ã‚Œã‚“ã€‚ã€</div>
            </div>
            
            <div style="height: 20px;"></div>
        </div>

        <div id="page-shop" class="page">
            <h3 style="margin:20px;">âš”ï¸ æ­¦å™¨å±‹</h3>
            <div id="shop-list"></div>
        </div>

        <div id="page-zukan" class="page">
            <h3 style="margin:20px;">ğŸ“– è¨ä¼å›³é‘‘</h3>
            <div id="zukan-list"></div>
        </div>
    </div>

    <div class="fixed-scan-container" id="scan-container">
        <button class="share-btn" id="share-btn" onclick="shareTwitter()">
            ğŸ¦ å‹åˆ©ã‚’å ±å‘Šã™ã‚‹ (X)
        </button>

        <label class="scan-btn" id="scan-btn" style="opacity:0.5;">
            <span>ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³</span>
            <input type="file" accept="image/*" capture="environment" style="display:none" onchange="processReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">âš”ï¸ å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">ğŸ° æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">ğŸ“– å›³é‘‘</button>
    </div>

    <script>
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";
        let activeModel = "";

        const defaultData = { 
            lv: 1, gold: 0, exp: 0, realSavings: 0, weaponId: 0,
            visited: false, zukan: [] 
        };
        const weapons = [
            { id: 1, name: "ã²ã®ãã®æ£’", price: 500, atk: 500 },
            { id: 2, name: "éŠ…ã®ã¤ã‚‹ã", price: 2000, atk: 1500 },
            { id: 3, name: "é‹¼ã®ã‚ªãƒ",   price: 5000, atk: 3500 },
            { id: 4, name: "é­”æ³•ã®æ–",   price: 10000, atk: 8000 },
            { id: 5, name: "å‹‡è€…ã®å‰£",   price: 30000, atk: 50000 }
        ];

        let gameData = JSON.parse(localStorage.getItem('rd_save_v6')) || defaultData;
        let audioCtx;
        let lastBattleResult = null; // ã‚·ã‚§ã‚¢ç”¨

        window.onload = async function() {
            createParticles();
            updateUI();
            renderShop();
            renderZukan();
            
            if (!gameData.visited) {
                document.getElementById('tutorial-modal').style.display = 'flex';
            }

            const statusSpan = document.getElementById('model-status');
            const scanBtn = document.getElementById('scan-btn');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await response.json();
                const bestModel = data.models?.find(m => m.name.includes("flash")) || data.models?.[0];
                
                if (bestModel) {
                    activeModel = bestModel.name.replace("models/", "");
                    statusSpan.innerText = "ONLINE";
                    statusSpan.style.color = "#4ade80";
                    scanBtn.style.opacity = "1";
                }
            } catch (e) {
                statusSpan.innerText = "OFFLINE";
            }
        };

        function closeTutorial() {
            document.getElementById('tutorial-modal').style.display = 'none';
            gameData.visited = true;
            saveData();
            playSound('select');
        }

        async function processReceipt(input) {
            if (!input.files || !input.files[0] || !activeModel) return;
            initAudio(); playSound('scan');
            document.getElementById('share-btn').style.display = 'none'; // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³éš ã™

            const log = document.getElementById('log');
            const emoji = document.getElementById('monster-emoji');
            const hpBox = document.getElementById('hp-box');
            const hpBar = document.getElementById('hp-bar');
            const nameDiv = document.getElementById('monster-name');

            emoji.innerText = "â³";
            emoji.className = "monster-emoji"; // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
            hpBox.style.display = 'none';
            nameDiv.innerText = "è§£æä¸­...";
            addLog("ğŸ“¡ ç•°ä¸–ç•Œã¨é€šä¿¡ä¸­...");
            
            try {
                const base64 = await compressImage(input.files[0]);
                const prompt = `ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’RPGã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨ã—ã¦è§£æã—ã¦ã€‚
                JSONå‡ºåŠ›: {"amount":åˆè¨ˆé‡‘é¡, "name":"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ã®åå‰", "emoji":"çµµæ–‡å­—", "type":"waste(æµªè²»)ã‹invest(æŠ•è³‡)", "comment":"çŸ­ã„ã‚»ãƒªãƒ•"}
                ä¾‹: 3000å††ã®æœ¬â†’ã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«, 500å††ã®è“å­â†’ã‚¹ãƒ©ã‚¤ãƒ ã‚¹ãƒŠãƒƒã‚¯`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                
                const data = await response.json();
                const cleanText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const res = JSON.parse(cleanText);

                const enemyHp = res.amount || 100;
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒåŠ› = æ­¦å™¨ + (ãƒ¬ãƒ™ãƒ« x 50)
                const weaponAtk = weapons.find(w => w.id === gameData.weaponId)?.atk || 100;
                const levelBonus = gameData.lv * 50;
                let totalAtk = weaponAtk + levelBonus;
                
                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¤å®š(è‰²)
                let rarityClass = "rarity-1";
                if(enemyHp > 2000) rarityClass = "rarity-2";
                if(enemyHp > 5000) rarityClass = "rarity-3";
                if(enemyHp > 10000) rarityClass = "rarity-4";

                playSound('appear');
                emoji.innerText = res.emoji || "ğŸ‘¾";
                nameDiv.innerText = `${res.name}`;
                nameDiv.className = rarityClass; // è‰²é©ç”¨
                hpBox.style.display = 'block';
                hpBar.style.width = '100%';
                
                addLog(`âš”ï¸ <span class="${rarityClass}">${res.name}</span> (HP:${enemyHp}) ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ğŸ’¬ã€Œ${res.comment}ã€`);

                // ãƒãƒˆãƒ«å‡¦ç†
                setTimeout(() => {
                    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š (10%)
                    let isCrit = Math.random() < 0.1;
                    if (isCrit) {
                        totalAtk *= 2;
                        playSound('crit');
                        flashScreen();
                    } else {
                        playSound('attack');
                    }

                    emoji.classList.add("shake");
                    
                    // ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡º
                    const dmgText = isCrit ? `âš¡${totalAtk}!!` : `ğŸ’¥${totalAtk}`;
                    const dmgColor = isCrit ? '#ffd700' : '#ff5555';
                    showPopup(dmgText, dmgColor);
                    
                    if (totalAtk >= enemyHp) {
                        hpBar.style.width = '0%';
                        setTimeout(() => {
                            playSound('win');
                            emoji.innerText = "ğŸ’€";
                            
                            const savingRate = res.type === "waste" ? 0.1 : 0.05;
                            const realMoney = Math.floor(enemyHp * savingRate);
                            
                            gameData.gold += enemyHp;
                            gameData.realSavings += realMoney;
                            
                            addLog(`ğŸ‰ å‹åˆ©ï¼ ${enemyHp}G ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
                            if(isCrit) addLog(`âš¡ ä¼šå¿ƒã®ä¸€æ’ƒã ã£ãŸï¼`);
                            
                            // å›³é‘‘
                            gameData.zukan.unshift({ name: res.name, price: enemyHp, emoji: res.emoji, type: res.type });
                            if(gameData.zukan.length > 50) gameData.zukan.pop();

                            // ã‚·ã‚§ã‚¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼†ãƒœã‚¿ãƒ³è¡¨ç¤º
                            lastBattleResult = { name: res.name, price: enemyHp };
                            document.getElementById('share-btn').style.display = 'flex';

                            checkLevelUp();
                            saveData();
                            updateUI();
                            renderZukan();
                        }, 800);
                    } else {
                        // è² ã‘
                        hpBar.style.width = '80%'; // å°‘ã—æ¸›ã‚‹
                        playSound('damage');
                        addLog(`ğŸ›¡ï¸ ç¡¬ã„ï¼(æ”»æ’ƒåŠ›:${totalAtk} < HP:${enemyHp})`);
                        addLog(`ğŸ’¦ é€ƒã’å‡ºã—ãŸ... ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¦å‡ºç›´ãã†ã€‚`);
                    }
                }, 1000);

            } catch (e) {
                console.error(e);
                addLog("âŒ è§£æå¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ã€‚");
                emoji.innerText = "ğŸ‘»";
            }
            input.value = ""; 
        }

        // --- ã‚·ã‚§ã‚¢æ©Ÿèƒ½ ---
        function shareTwitter() {
            if(!lastBattleResult) return;
            const text = `å®¶è¨ˆç°¿RPGã€ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã€ã§\nã€Œ${lastBattleResult.name} (Â¥${lastBattleResult.price})ã€ã‚’æ’ƒç ´ã—ã¾ã—ãŸï¼âš”ï¸\n\nç„¡é§„é£ã„ã‚’å€’ã—ã¦è²¯é‡‘ä¸­ğŸ’°\n#ãƒ¬ã‚·ãƒ¼ãƒˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³`;
            const url = "https://receipt-dungeon.vercel.app"; // ã‚ãªãŸã®URL
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function flashScreen() {
            const el = document.getElementById('flash-layer');
            el.className = 'flash';
            setTimeout(() => el.className = '', 200);
        }

        // --- åŸºæœ¬æ©Ÿèƒ½ ---
        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold.toLocaleString();
            document.getElementById('ui-save').innerText = gameData.realSavings.toLocaleString();
        }
        function addLog(text) { 
            const log = document.getElementById('log'); 
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = text;
            log.prepend(entry);
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach(w => {
                const isBought = gameData.weaponId >= w.id;
                const div = document.createElement("div");
                div.className = "shop-item";
                div.style.opacity = isBought ? "0.5" : "1";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:${isBought?'#aaa':'#fff'}">${w.name}</div>
                        <div style="font-size:12px; color:#aaa;">ATK +${w.atk}</div>
                    </div>
                    <div class="btn" style="width:auto; background:${isBought?'#333': 'var(--accent)'}; border-color:${isBought?'#555':'#fff'}">
                        ${isBought ? 'è£…å‚™ä¸­' : w.price + 'G'}
                    </div>`;
                if (!isBought) div.onclick = () => {
                    initAudio();
                    if (gameData.gold >= w.price) {
                        if(confirm(`${w.name} ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            gameData.gold -= w.price; gameData.weaponId = w.id;
                            playSound('win'); saveData(); updateUI(); renderShop();
                        }
                    } else { alert("GãŒè¶³ã‚Šã¾ã›ã‚“"); }
                };
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            if (gameData.zukan.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555;">è¨˜éŒ²ãªã—</div>`; return;
            }
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'zukan-item';
                div.style.borderLeft = `4px solid ${z.type === 'waste' ? '#ff5555' : '#4ade80'}`;
                div.innerHTML = `<div class="zukan-emoji">${z.emoji||'ğŸ‘¾'}</div><div style="flex:1;"><div style="font-weight:bold;">${z.name}</div><div style="font-size:12px; color:#aaa;">${z.price}G</div></div>`;
                list.appendChild(div);
            });
        }

        function changeTab(name) {
            initAudio(); playSound('select');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + name).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            const scanContainer = document.getElementById('scan-container');
            scanContainer.style.display = name === 'adventure' ? 'flex' : 'none';
        }

        function checkLevelUp() {
            const nextLvExp = gameData.lv * 1000;
            gameData.exp += 100;
            if (gameData.exp >= nextLvExp) {
                gameData.lv++;
                playSound('levelup');
                showPopup(`ğŸ†™ LEVEL UP!`, '#fff');
            }
        }

        function showPopup(text, color) {
            const stage = document.getElementById('battle-stage');
            const el = document.createElement('div');
            el.className = 'popup-text';
            el.style.color = color;
            el.innerText = text;
            el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';
            stage.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function saveData() { localStorage.setItem('rd_save_v6', JSON.stringify(gameData)); }
        function createParticles() { /* å‰ã¨åŒã˜ */ 
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div'); p.className = 'particle';
                p.style.left = Math.random() * 100 + '%'; p.style.animationDelay = Math.random() * 5 + 's';
                p.style.opacity = Math.random(); container.appendChild(p);
            }
        }

        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'scan') { osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.1, now); osc.stop(now + 0.1); }
            else if (type === 'appear') { osc.type='triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(300, now+0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.3); osc.stop(now+0.3); }
            else if (type === 'win') { osc.type='square'; osc.frequency.setValueAtTime(523, now); osc.frequency.setValueAtTime(659, now+0.1); osc.frequency.setValueAtTime(784, now+0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.4); osc.stop(now+0.4); }
            else if (type === 'crit') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(800, now+0.2); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.2); osc.stop(now+0.2); }
            else if (type === 'damage') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now+0.2); osc.stop(now+0.2); }
            else { osc.frequency.setValueAtTime(440, now); gain.gain.setValueAtTime(0.05, now); osc.stop(now+0.1); }
            osc.start(now);
        }

        function compressImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.onload = (e) => {
                    const img = new Image(); img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxW = 600; const scale = maxW / img.width;
                        canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
