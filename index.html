<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ | ãƒ¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦æˆ¦ã†å®¶è¨ˆç°¿RPG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #20202d; --win: #16161d; --text: #fff; --accent: #e94560; --gold: #ffd700; --hp: #4ade80; --dmg: #ff5555; }
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: 'DotGothic16', sans-serif; 
            margin: 0; padding: 0; text-align: center; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #2a2a35 0%, #000 100%);
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ ã®å¤‰æ›´ --- */
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ */
        .status-bar {
            background: rgba(22, 22, 29, 0.95); padding: 10px; border-bottom: 2px solid #fff;
            display: grid; grid-template-columns: 1fr 1fr; font-size: 14px; align-items: center; gap: 5px; 
            z-index: 50; /* æœ€å‰é¢ã« */
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        
        .real-save-box {
            grid-column: span 2; background: #333; border-radius: 4px; padding: 5px; margin-top: 5px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #555;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½é ˜åŸŸï¼‰ */
        .content-area {
            flex: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’å…¨ã¦ä½¿ã† */
            overflow-y: auto; /* ã“ã“ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ */
            position: relative;
            padding-bottom: 140px; /* ä¸‹éƒ¨ã®ãƒœã‚¿ãƒ³ã¨ã‚¿ãƒ–ã®ãŸã‚ã«ä½™ç™½ã‚’ç¢ºä¿ */
            -webkit-overflow-scrolling: touch;
        }

        /* èƒŒæ™¯ã®ç²’å­ */
        .particles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: float 10s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-10vh); opacity: 0; } }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 100; display: flex; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--win); border: 2px solid #fff; padding: 20px; width: 85%; max-width: 400px;
            text-align: left; box-shadow: 0 0 20px var(--accent); border-radius: 8px;
        }

        /* ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ */
        .battle-stage {
            height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-top: 20px; margin-bottom: 10px; position: relative;
        }
        .monster-emoji { font-size: 90px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); transition: transform 0.2s; }
        
        /* HPãƒãƒ¼ */
        .hp-box { width: 150px; height: 12px; background: #333; border: 2px solid #fff; margin-top: 10px; border-radius: 10px; overflow: hidden; display: none; }
        .hp-bar { width: 100%; height: 100%; background: var(--hp); transition: width 0.3s ease-out; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° */
        .message-window {
            background: rgba(22, 22, 29, 0.8); border: 1px solid #777; border-radius: 4px;
            padding: 15px; margin: 0 20px 20px 20px; text-align: left; min-height: 80px;
            font-size: 16px; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 4px; }

        /* --- å›ºå®šã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ --- */
        .fixed-scan-container {
            position: fixed;
            bottom: 70px; /* ã‚¿ãƒ–ãƒãƒ¼(60px)ã®ã™ãä¸Š */
            left: 0; width: 100%;
            display: flex; justify-content: center;
            z-index: 40;
            padding: 0 20px; box-sizing: border-box;
            background: linear-gradient(to top, var(--bg) 20%, transparent); /* ä¸‹ã®æ–¹ã‚’å°‘ã—æš—ãã—ã¦æ–‡å­—ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã« */
            pointer-events: none; /* ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
        }
        
        .scan-btn {
            background: var(--accent); color: #fff; border: 2px solid #fff;
            padding: 15px 0; font-size: 18px; font-family: inherit; font-weight: bold;
            cursor: pointer; border-radius: 30px; width: 100%; max-width: 400px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-shadow: 1px 1px 0 #000;
            pointer-events: auto; /* ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .scan-btn:active { transform: scale(0.98); }

        /* é€šå¸¸ãƒœã‚¿ãƒ³ï¼ˆã‚·ãƒ§ãƒƒãƒ—ç”¨ãªã©ï¼‰ */
        .btn {
            background: #333; color: #fff; border: 1px solid #fff;
            padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%;
        }

        /* ãƒšãƒ¼ã‚¸åˆ¶å¾¡ */
        .page { display: none; }
        .page.active { display: block; }
        
        /* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */
        .shop-item { background: rgba(50,50,50,0.8); border: 1px solid #777; padding: 15px; margin: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }
        .zukan-item { background: rgba(30,30,40,0.8); border: 1px solid #555; padding: 10px; margin: 5px 20px; display: flex; align-items: center; text-align: left; font-size: 14px; }
        .zukan-emoji { font-size: 30px; margin-right: 10px; }

        /* ã‚¿ãƒ–ãƒãƒ¼ï¼ˆä¸‹éƒ¨å›ºå®šï¼‰ */
        .tabs { display: flex; background: #000; border-top: 2px solid #fff; height: 60px; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; }
        .tab { flex: 1; border: none; background: #000; color: #777; font-family: inherit; font-size: 14px; cursor: pointer; border-right: 1px solid #333; }
        .tab.active { color: #fff; background: #222; font-weight: bold; border-top: 4px solid var(--accent); }

        .popup-text { position: absolute; font-size: 24px; font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 2px 2px 0 #000; z-index: 20; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body>

    <div class="particles" id="particles"></div>

    <div class="modal-overlay" id="tutorial-modal" style="display:none;">
        <div class="modal-box">
            <h3 style="color:var(--gold); border-bottom:1px solid #555; padding-bottom:5px; margin-top:0;">ğŸ° ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</h3>
            <p>ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ãã†ï¼</p>
            <ul style="padding-left: 20px; font-size:14px; line-height: 1.8;">
                <li>ğŸ“¸ <b>ã‚¹ã‚­ãƒ£ãƒ³:</b> ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ’®å½±</li>
                <li>âš”ï¸ <b>ãƒãƒˆãƒ«:</b> å¼·ã„æ­¦å™¨ã‚’è²·ã£ã¦å€’ã™</li>
                <li>ğŸ’° <b>è²¯é‡‘:</b> æµ®ã„ãŸãŠé‡‘ã¯ç¾å®Ÿã§è²¯é‡‘ï¼</li>
            </ul>
            <button class="scan-btn" onclick="closeTutorial()" style="width:100%; font-size:16px;">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>

    <div class="status-bar">
        <div>LV.<span id="ui-lv">1</span></div>
        <div style="color:var(--gold)">ğŸ’° <span id="ui-gold">0</span> G</div>
        <div class="real-save-box">
            <span>ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘</span>
            <span style="color:var(--hp); font-size:16px;">Â¥ <span id="ui-save">0</span></span>
        </div>
    </div>

    <div class="content-area">
        
        <div id="page-adventure" class="page active">
            <div style="font-size:12px; color:#aaa; margin-top:5px;">AIæ¥ç¶š: <span id="model-status">...</span></div>
            
            <div class="battle-stage" id="battle-stage">
                <div id="monster-emoji" class="monster-emoji">ğŸ°</div>
                <div class="hp-box" id="hp-box"><div class="hp-bar" id="hp-bar"></div></div>
                <div id="monster-name" style="margin-top:5px; font-weight:bold; height:20px;"></div>
            </div>

            <div class="message-window" id="log">
                <div class="log-entry">è³¢è€…ã€Œãƒ¬ã‚·ãƒ¼ãƒˆãŒãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®å…¥ã‚Šå£ã˜ã‚ƒã€‚ã€</div>
            </div>
            
            <div style="height: 20px;"></div>
        </div>

        <div id="page-shop" class="page">
            <h3 style="margin:20px;">âš”ï¸ æ­¦å™¨å±‹</h3>
            <p style="font-size:12px; color:#aaa;">å¼·ã„æ­¦å™¨ãŒãªã„ã¨é«˜é¡ãªé­”ç‰©ã¯å€’ã›ã¾ã›ã‚“</p>
            <div id="shop-list"></div>
        </div>

        <div id="page-zukan" class="page">
            <h3 style="margin:20px;">ğŸ“– è¨ä¼å›³é‘‘</h3>
            <div id="zukan-list"></div>
        </div>

    </div>

    <div class="fixed-scan-container" id="scan-container">
        <label class="scan-btn" id="scan-btn" style="opacity:0.5;">
            <span>ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³</span>
            <input type="file" accept="image/*" capture="environment" style="display:none" onchange="processReceipt(this)">
        </label>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="changeTab('adventure')">âš”ï¸ å†’é™º</button>
        <button class="tab" onclick="changeTab('shop')">ğŸ° æ­¦å™¨å±‹</button>
        <button class="tab" onclick="changeTab('zukan')">ğŸ“– å›³é‘‘</button>
    </div>

    <script>
        // --- è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ ---
        const API_KEY = "AIzaSyBhPxGTYuDJQArPpo8YXlheiOGkwboyoms";
        let activeModel = "";

        const defaultData = { 
            lv: 1, gold: 0, exp: 0, realSavings: 0, weaponId: 0,
            visited: false, zukan: [] 
        };
        const weapons = [
            { id: 1, name: "ã²ã®ãã®æ£’", price: 500, atk: 1000 },
            { id: 2, name: "éŠ…ã®ã¤ã‚‹ã", price: 2500, atk: 3000 },
            { id: 3, name: "é‹¼ã®ã‚ªãƒ",   price: 5000, atk: 5000 },
            { id: 4, name: "ç‚ã®ãƒ­ãƒƒãƒ‰", price: 10000, atk: 10000 },
            { id: 5, name: "å‹‡è€…ã®å‰£",   price: 30000, atk: 999999 }
        ];

        let gameData = JSON.parse(localStorage.getItem('rd_save_v5')) || defaultData;
        let audioCtx;

        // --- åˆæœŸåŒ– ---
        window.onload = async function() {
            createParticles();
            updateUI();
            renderShop();
            renderZukan();
            
            if (!gameData.visited) {
                document.getElementById('tutorial-modal').style.display = 'flex';
            }

            // AIæ¥ç¶šãƒã‚§ãƒƒã‚¯
            const statusSpan = document.getElementById('model-status');
            const scanBtn = document.getElementById('scan-btn');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
                const data = await response.json();
                const bestModel = data.models?.find(m => m.name.includes("flash")) || data.models?.[0];
                
                if (bestModel) {
                    activeModel = bestModel.name.replace("models/", "");
                    statusSpan.innerText = "ONLINE";
                    statusSpan.style.color = "#4ade80";
                    scanBtn.style.opacity = "1";
                }
            } catch (e) {
                statusSpan.innerText = "OFFLINE (Error)";
            }
        };

        function closeTutorial() {
            document.getElementById('tutorial-modal').style.display = 'none';
            gameData.visited = true;
            saveData();
            playSound('select');
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function processReceipt(input) {
            if (!input.files || !input.files[0] || !activeModel) return;
            initAudio(); playSound('scan');

            const log = document.getElementById('log');
            const emoji = document.getElementById('monster-emoji');
            const hpBox = document.getElementById('hp-box');
            const hpBar = document.getElementById('hp-bar');
            const nameDiv = document.getElementById('monster-name');

            emoji.innerText = "â³";
            hpBox.style.display = 'none';
            nameDiv.innerText = "è§£æä¸­...";
            addLog("ğŸ“¡ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æã—ã¦ã„ã¾ã™...");
            
            try {
                const base64 = await compressImage(input.files[0]);
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å°‘ã—èª¿æ•´ï¼ˆã‚ˆã‚Šã‚²ãƒ¼ãƒ çš„ã«ï¼‰
                const prompt = `ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’RPGã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨ã—ã¦è§£æã—ã¦ãã ã•ã„ã€‚
                å‡ºåŠ›ã¯JSONã®ã¿: {"amount":åˆè¨ˆé‡‘é¡(æ•°å€¤), "name":"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼é¢¨ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å", "emoji":"ãã®è¦‹ãŸç›®ã®çµµæ–‡å­—", "type":"waste(æµªè²»)ã‹invest(æŠ•è³‡)ã‹", "comment":"ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚‰ã®çŸ­ã„å°è©"}
                ä¾‹: ãƒãƒ†ãƒãªã‚‰ã€Œãƒãƒ†ãƒˆã‚´ãƒ¼ãƒ¬ãƒ ã€ã€æœ¬ãªã‚‰ã€Œã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«ã€ãªã©ã€‚`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${activeModel}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                
                const data = await response.json();
                const cleanText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const res = JSON.parse(cleanText);

                const enemyHp = res.amount || 100;
                const myWeapon = weapons.find(w => w.id === gameData.weaponId) || { name:"ç´ æ‰‹", atk: 500 };
                
                // ãƒãƒˆãƒ«é–‹å§‹
                playSound('appear');
                emoji.innerText = res.emoji || "ğŸ‘¾";
                nameDiv.innerText = `${res.name} (HP:${enemyHp})`;
                hpBox.style.display = 'block';
                hpBar.style.width = '100%';
                
                addLog(`âš”ï¸ <b>${res.name}</b> ãŒç¾ã‚ŒãŸï¼`);
                addLog(`ã€Œ${res.comment}ã€`);

                // æ”»æ’ƒå‡¦ç†
                setTimeout(() => {
                    if (myWeapon.atk >= enemyHp) {
                        playSound('attack');
                        emoji.classList.add("shake");
                        showPopup(`ğŸ’¥ ${enemyHp}`, '#ff5555');
                        hpBar.style.width = '0%';

                        setTimeout(() => {
                            playSound('win');
                            emoji.innerText = "ğŸ’€";
                            addLog(`ğŸ‰ <b>${res.name}</b> ã‚’å€’ã—ãŸï¼`);
                            
                            const savingRate = res.type === "waste" ? 0.1 : 0.05;
                            const realMoney = Math.floor(enemyHp * savingRate);
                            
                            gameData.gold += enemyHp;
                            gameData.realSavings += realMoney;
                            
                            gameData.zukan.unshift({ name: res.name, price: enemyHp, emoji: res.emoji, type: res.type });
                            if(gameData.zukan.length > 50) gameData.zukan.pop();

                            showPopup(`ğŸ’° +${enemyHp} G`, '#ffd700');
                            addLog(`ğŸ¦ ãƒªã‚¢ãƒ«è²¯é‡‘ç®±ã« +${realMoney}å††`);
                            
                            checkLevelUp();
                            saveData();
                            updateUI();
                        }, 800);
                    } else {
                        playSound('damage');
                        addLog(`ğŸ›¡ï¸ æ”»æ’ƒãŒé€šã˜ãªã„ï¼(æ­¦å™¨æ”»æ’ƒåŠ›:${myWeapon.atk} < æ•µHP:${enemyHp})`);
                        addLog(`ğŸ’¦ é€ƒã’å‡ºã—ãŸ... æ­¦å™¨å±‹ã§è£…å‚™ã‚’æ•´ãˆã‚ˆã†ã€‚`);
                    }
                }, 1200);

            } catch (e) {
                console.error(e);
                addLog("âŒ è§£æå¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
                emoji.innerText = "ğŸ°";
                nameDiv.innerText = "";
            }
            input.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚å†ç™ºç«ã™ã‚‹ã‚ˆã†ã«
        }

        // --- UIæ›´æ–°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function addLog(text) { 
            const log = document.getElementById('log'); 
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = text;
            log.prepend(entry); // æ–°ã—ã„ã‚‚ã®ã‚’ä¸Šã«
        }

        function updateUI() {
            document.getElementById('ui-lv').innerText = gameData.lv;
            document.getElementById('ui-gold').innerText = gameData.gold.toLocaleString();
            document.getElementById('ui-save').innerText = gameData.realSavings.toLocaleString();
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            weapons.forEach(w => {
                const isBought = gameData.weaponId >= w.id;
                const div = document.createElement("div");
                div.className = "shop-item";
                div.style.opacity = isBought ? "0.5" : "1";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:${isBought?'#aaa':'#fff'}">${w.name}</div>
                        <div style="font-size:12px; color:#aaa;">æ”»æ’ƒåŠ› ${w.atk}</div>
                    </div>
                    <div class="btn" style="width:auto; background:${isBought?'#333': 'var(--accent)'}; border-color:${isBought?'#555':'#fff'}">
                        ${isBought ? 'è³¼å…¥æ¸ˆ' : w.price + 'G'}
                    </div>`;
                if (!isBought) div.onclick = () => {
                    initAudio();
                    if (gameData.gold >= w.price) {
                        if(confirm(`${w.name} ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            gameData.gold -= w.price; gameData.weaponId = w.id;
                            playSound('win'); saveData(); updateUI(); renderShop();
                        }
                    } else {
                        alert("ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                    }
                };
                list.appendChild(div);
            });
        }

        function renderZukan() {
            const list = document.getElementById('zukan-list');
            if (gameData.zukan.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555; margin-top:30px;">ã¾ã è¨ä¼è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
                return;
            }
            list.innerHTML = "";
            gameData.zukan.forEach(z => {
                const div = document.createElement('div');
                div.className = 'zukan-item';
                div.style.borderLeft = `4px solid ${z.type === 'waste' ? '#ff5555' : '#4ade80'}`;
                div.innerHTML = `
                    <div class="zukan-emoji">${z.emoji || 'ğŸ‘¾'}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${z.name}</div>
                        <div style="font-size:12px; color:#aaa;">${z.type==='waste'?'æµªè²»':'æŠ•è³‡'} / ${z.price}G</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function changeTab(name) {
            initAudio(); playSound('select');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + name).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // å†’é™ºã‚¿ãƒ–ä»¥å¤–ã§ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’éš ã™
            const scanContainer = document.getElementById('scan-container');
            if (name === 'adventure') {
                scanContainer.style.display = 'flex';
            } else {
                scanContainer.style.display = 'none';
            }
        }

        function checkLevelUp() {
            const nextLvExp = gameData.lv * 1000;
            gameData.exp += 100;
            if (gameData.exp >= nextLvExp) {
                gameData.lv++;
                playSound('levelup');
                showPopup(`ğŸ†™ LEVEL UP!`, '#fff');
            }
        }

        function showPopup(text, color) {
            const stage = document.getElementById('battle-stage');
            const el = document.createElement('div');
            el.className = 'popup-text';
            el.style.color = color;
            el.innerText = text;
            el.style.left = '50%';
            el.style.top = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            stage.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function saveData() { localStorage.setItem('rd_save_v5', JSON.stringify(gameData)); }

        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 5 + 's';
                p.style.opacity = Math.random();
                container.appendChild(p);
            }
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            const sounds = {
                select: () => {
                    osc.type = 'square'; osc.frequency.setValueAtTime(440, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.05);
                    gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                },
                scan: () => {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.2);
                },
                appear: () => {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(300, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                },
                attack: () => {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.1);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                },
                win: () => {
                    osc.type = 'square'; 
                    osc.frequency.setValueAtTime(523, now); 
                    osc.frequency.setValueAtTime(659, now + 0.1); 
                    osc.frequency.setValueAtTime(784, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4);
                },
                levelup: () => {
                    osc.type = 'square'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                },
                damage: () => {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                }
            };
            if(sounds[type]) sounds[type]();
        }

        function compressImage(file) { 
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.onload = (e) => {
                    const img = new Image(); img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxW = 600; const scale = maxW / img.width;
                        canvas.width = scale < 1 ? maxW : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
